/*!
  * vue-mfe v1.0.4
  * (c) 2019 Vuchan
  * @license MIT
  */
var t,e;t=this,e=function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e=function(){},n=function(t){return Array.isArray(t)},r=function(t){return t&&"function"==typeof t},i=function(t){return t&&"object"==typeof t},o=function(t){return"string"==typeof t},a=function(t){return Array.prototype.slice.call(t)},s="undefined"!=typeof console&&"function"==typeof console.warn;function u(t,e,n){return t?r(e)&&e():r(n)&&n()}var p=function(t){return function(n){return u(!1,function(){return s&&console.log.apply(null,t?[t].concat(a(n)):n)},e)}},c=function(t){return function(n){var r=s?console.warn:e;return u(!0,function(){r.apply(null,t?[[t].concat(a(n)).join(" > ")]:n)})}};function f(){this.events={}}function l(t){t&&t instanceof HTMLElement&&("function"==typeof t.remove?t.remove():t.parentNode.removeChild(t))}f.prototype.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this.events[t]},f.prototype.off=function(t,e){if(t){var n=this.events[t];if(n&&n.length)return e?n.filter(function(t){return t===e}):(delete this.events[t],!0)}else this.events={}},f.prototype.emit=function(t){for(var e=[],n=arguments.length-1;n-- >0;)e[n]=arguments[n+1];var r=this.events[t];if(r)return r.forEach(function(t){return t.apply(null,e)}),!0};var h=function(){this.cached={}};function d(t,e){void 0===t&&(t=[]);for(var n=0,r=null,i=t.length;n<i;){var o=t[n],a=o.path,s=o.children;if(a===e)return o;if(s&&s.length?(r=d(s,e),n++):n++,r)return r}}function m(t,e){return"/"===e&&"/"!==t&&t.startsWith("/")?v(t):v(e)+v(t)}function v(t){return(t="/"!==t?t.replace(/\/?$/,""):t)?function(t){return"/"===t.charAt(0)}(t)?t:"/"+t:"/"}h.log=function(){return p("VueMfe."+h.name)(arguments)},h.warn=function(){return c("VueMfe."+h.name)(arguments)},h.prototype.load=function(t){var e=this,i=t.name;return this.getRouteEntry(i).then(function(t){var o=r(t)?t():t;return h.log("start to load "+i+" resources:",o),e.installResources((n(o)?o:[o]).filter(Boolean),e.getName(i))})},h.prototype.getRouteEntry=function(t){var e=this,n=this.cached[t];return n?Promise.resolve(n):Promise.resolve(this.getResource(t)).then(function(n){if(void 0===n&&(n={}),e.cached=Object.assign({},e.cached,n),n[t])return n[t];h.log("all resources",JSON.stringify(n)),h.warn("The App '"+t+"' cannot be found in method 'config.getResource()'")})},h.prototype.installResources=function(t,e){var r,i=t.filter(function(t){return t.endsWith(".css")}),o=t.filter(function(t){return t.endsWith(".js")});if(n(i)&&i.length&&Promise.all(i.map(function(t){return e=t,(n=document.createElement("link")).type="text/css",n.rel="stylesheet",n.charset="utf-8",n.href=e,n.setAttribute("force",!1),new Promise(function(t,e){var r=setTimeout(function(){return i(!0)},12e3);function i(t){clearTimeout(r),n.onerror=n.onload=n.onreadystatechange=null,t&&n&&l(n)}n.onload=function(){i(),t.apply(void 0,arguments)},n.onerror=function(){i(!0),e.apply(void 0,arguments)},document.head.appendChild(n)});var e,n})).catch(function(t){return h.warn(t)}),n(o)&&o.length)return(r=o.map(function(t){return function(){return function(t,e){var n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=t,n.async=!0,n.setAttribute("nonce","nonce"),new Promise(function(r,i){var o=setTimeout(function(){return u("Reject script "+t+": LOAD_SCRIPT_TIMEOUT")},12e3);function a(){clearTimeout(o),n.onerror=n.onload=n.onreadystatechange=null,l(n)}function s(){for(var t=arguments.length,n=Array(t);t--;)n[t]=arguments[t];a(),r.apply(void 0,[e?window[e]:void 0].concat(n))}function u(){a(),i.apply(void 0,arguments)}void 0!==n.readyState?n.onreadystatechange=function(t){"loaded"!==n.readyState&&"complete"!==n.readyState||e&&!window[e]?u("Unknown error happened",t):s()}:(n.onload=s,n.onerror=function(e){u("GET "+t+" net::ERR_CONNECTION_REFUSED",e)}),document.body.appendChild(n)})}(t,e)}}),r.reduce(function(t,e){return t.then(function(t){return e(t)}).catch(function(t){throw t})},Promise.resolve())).catch(function(t){throw t});h.warn("no any valid entry script be found in "+t)},h.prototype.getResource=function(t){return this.getConfig(t).getResource()},h.prototype.getName=function(t){return this.getConfig(t).getNamespace(t)},h.prototype.getConfig=function(t){return void 0===t&&(t="*"),this.configs[t]||this.configs["*"]},h.prototype.setConfig=function(t,e){return i(t)&&(e=t,t="*"),this.configs||(this.configs={}),this.configs[t]=e,this};var y=function(t,e){var n,r=[],i=0,o=0,a="",s=e&&e.delimiter||A,u=e&&e.whitelist||void 0,p=!1;for(;null!==(n=E.exec(t));){var c=n[0],f=n[1],l=n.index;if(a+=t.slice(o,l),o=l+c.length,f)a+=f[1],p=!0;else{var h="",d=n[2],m=n[3],v=n[4],y=n[5];if(!p&&a.length){var g=a.length-1,O=a[g],P=!u||u.indexOf(O)>-1;P&&(h=O,a=a.slice(0,g))}a&&(r.push(a),a="",p=!1);var w="+"===y||"*"===y,T="?"===y||"*"===y,x=m||v,C=h||s;r.push({name:d||i++,prefix:h,delimiter:C,optional:T,repeat:w,pattern:x?R(x):"[^"+_(C===s?C:C+s)+"]+?"})}}(a||o<t.length)&&r.push(a+t.substr(o));return r},g=function(t,e,n){for(var r=(n=n||{}).strict,i=!1!==n.start,o=!1!==n.end,a=n.delimiter||A,s=[].concat(n.endsWith||[]).map(_).concat("$").join("|"),u=i?"^":"",p=0;p<t.length;p++){var c=t[p];if("string"==typeof c)u+=_(c);else{var f=c.repeat?"(?:"+c.pattern+")(?:"+_(c.delimiter)+"(?:"+c.pattern+"))*":c.pattern;e&&e.push(c),c.optional?c.prefix?u+="(?:"+_(c.prefix)+"("+f+"))?":u+="("+f+")?":u+=_(c.prefix)+"("+f+")"}}if(o)r||(u+="(?:"+_(a)+")?"),u+="$"===s?"$":"(?="+s+")";else{var l=t[t.length-1],h="string"==typeof l?l[l.length-1]===a:void 0===l;r||(u+="(?:"+_(a)+"(?="+s+"))?"),h||(u+="(?="+_(a)+"|"+s+")")}return new RegExp(u,function(t){return t&&t.sensitive?"":"i"}(n))},A="/",E=new RegExp(["(\\\\.)","(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?"].join("|"),"g");function _(t){return t.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function R(t){return t.replace(/([=!:$\/()])/g,"\\$1")}function O(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&-1===e.indexOf(r)&&(n[r]=t[r]);return n}var P,w=function(t){t.addRoutes!==this.addRoutes&&(t.addRoutes=this.addRoutes.bind(this)),this.router=t,this.routes=t.options.routes,this.pathMap={},this.pathList=[],this.appsMap={},this._init()};w.warn=function(){return c(w.name)(arguments)},w.prototype._init=function(){this.refreshAndCheckState(this.routes)},w.prototype.addRoutes=function(e,n,r){this.refreshAndCheckState(e,n),this.router.matcher=new t(this.normalizeOptions(this.adaptRouterOptions(r||this.router),{routes:e},n)).matcher},w.prototype.adaptRouterOptions=function(e){if(e){if(e instanceof t)return e.options;if(n(e))return{routes:e}}return{}},w.prototype.normalizeOptions=function(t,e,n){var r=t.routes;void 0===r&&(r=[]);var i=O(t,["routes"]),o=e.routes;void 0===o&&(o=[]);var a=O(e,["routes"]);return Object.assign({routes:this.mergeRoutes(r,o,n)},a,i)},w.prototype.mergeRoutes=function(t,e,n){var r=n;return e.forEach(function(e){if(o(e.parentPath)?(n=e.parentPath,delete e.parentPath):n=r,o(n))if(""===n)t.push(e);else{var i=d(t,n),a=e.path;i&&(i.children||(i.children=[])).push(Object.assign({},e,{path:n&&a.startsWith("/")?a=a.replace(/^\/*/,""):a}))}else t.push(e)}),t},w.prototype.refreshAndCheckState=function(t,e){var n=this;t.forEach(function(t){var r=t.path,i=t.parentPath,o=t.name,a=t.children,s=t.childrenApps;if(i?r=n.genParentPath(r,i,o):e&&(r=n.genParentPath(r,e,o)),r&&(n.pathExists(r)?w.warn("The path "+r+" in pathList has been existed"):n.pathList.push(r)),o&&(n.nameExists(o)?w.warn("The name "+o+" in pathMap has been existed"):n.pathMap[o]=r),s&&[].concat(s).forEach(function(t){if("object"==typeof t){var e=Object.entries(t).shift(),i=e[0],a=e[1];n.appsMap[m(a,r)]=i}else n.appsMap[m(t,r)]=o}),a&&a.length)return n.refreshAndCheckState(a,r)})},w.prototype.genParentPath=function(t,e,n){return this.pathExists(e)?m(t,e):(w.warn("Cannot found the parent path "+e+" "+(n?"of "+n:"")+" in Vue-MFE MasterRouter"),"")},w.prototype.pathExists=function(t){return this.pathList.includes(t)},w.prototype.nameExists=function(t){return this.pathMap[t]},w.prototype.getChildrenApps=function(t){var e=this.appsMap[t];if(!e){var n=function(t,e){var n=Object.keys(t);if(n)for(var r=n.map(function(t){return g(y(t))}),i=0,o=r.length;i++<o;)if(r[i].test(e))return n[i]}(this.appsMap,t);n&&(e=this.appsMap[n])}return e?[].concat(e):null},w.prototype.findRoute=function(t,e){var n=o(e)&&e||i(e)&&e.path;return n&&d(t||this.routes,n)||null};var T=function(e){function a(n){void 0===n&&(n={}),e.call(this),Vue||"undefined"==typeof window||!window.Vue||a.install.installed||a.install(window.Vue),n&&n.router&&n.router instanceof t||a.warn('Must pass the router property in "Vue.use(VueMfe, { router, config })"');var r=n.router,i=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&-1===e.indexOf(r)&&(n[r]=t[r]);return n}(n,["router"]);this.router=r,this.config=Object.assign({},a.DEFAULTS,i),this.installedApps={},this.helpers=new w(this.router),this.lazyloader=(new h).setConfig(this.config),this._init()}return e&&(a.__proto__=e),a.prototype=Object.create(e&&e.prototype),a.prototype.constructor=a,a.log=function(){return p(a.name)(arguments)},a.warn=function(){return c(a.name)(arguments)},a.install=function(t){if(!a.install.installed||P!==t)if(a.install.installed=!0,P=t,Number(t.version.split(".")[0])>=2)t.mixin({beforeCreate:n});else{var e=t.prototype._init;t.prototype._init=function(t){void 0===t&&(t={}),t.init=t.init?[n].concat(t.init):n,e.call(this,t)}}function n(){var t=this.$options;t.mfe?this.$mfe="function"==typeof t.mfe?t.mfe():t.mfe:t.parent&&t.parent.$mfe&&(this.$mfe=t.parent.$mfe)}},a.prototype._init=function(){var t=this;this.router.beforeEach(function(e,n,r){if(0!==e.matched.length&&0!==t.router.match(e.path).matched.length)return r();var i=t._getPrefixName(e),o={name:i,to:e,from:n,next:r};if(!t.isInstalled(i))return t.installApp(o);var s=t.helpers.getChildrenApps(e.path||e.fullPath);if(s&&s.length)return t._installChildrenApps(s,o);var u=new Error(i+" has been installed but it has no any path "+e.path);u.code=a.ERROR_CODE.LOAD_DUPLICATE_WITHOUT_PATH,t.emit("error",u,o)})},a.prototype.installApp=function(t){var e=this,n=t.name,r=t.next,i=t.to;if(this.isInstalled(n))return!0;this.installedApps[n]=a.LOAD_STATUS.START,this.emit("start",t);return this.loadAppEntry(t).then(function(t){return e.executeAppEntry(t)}).then(function(t){return e.installAppModule(t)}).then(function(o){return a.log("install app "+n+" success",o),o&&(e.installedApps[n]=a.LOAD_STATUS.SUCCESS,r&&i&&r(i),e.emit("end",t)),o}).catch(function(i){i instanceof Error||(i=new Error(i)),i.code||(i.code=a.ERROR_CODE.LOAD_ERROR_HAPPENED),e.installedApps[n]=a.LOAD_STATUS.FAILED,r&&r(!1),e.emit("error",i,t)})},a.prototype.loadAppEntry=function(t){return this.lazyloader.load("string"==typeof t?{name:t}:t)},a.prototype.executeAppEntry=function(t){t=function(t){return t&&t.default||t}(t);var e=this.router&&this.router.app;return r(t)?Promise.resolve(t(e)):n(t)?t:i(t)?r(t.init)&&Promise.resolve(t.init(e)):void 0},a.prototype.installAppModule=function(t){if(n(t))return t.length?(this.helpers.addRoutes(t,this.config.parentPath),!0):(a.warn("`Route[]` has no any valid item"),!1);var e=new Error("Module "+name+" initialize failed.");return t instanceof Error&&(e=t),e.code=a.ERROR_CODE.LOAD_APP_INIT_FAILED,a.warn(e),!1},a.prototype.isInstalled=function(t){var e=t;return i(t)&&/\//.exec(t.path)?e=this._getPrefixName(t):o(t)&&/\//.exec(t)&&(e=this._getPrefixNameByDelimiter(t,"/")),this.installedApps[e]===a.LOAD_STATUS.SUCCESS},a.prototype.preinstall=function(t){return t&&this.installApp({name:t})},a.prototype._installChildrenApps=function(t,e){var n=this,r=e.next,i=e.to,o=t.map(function(t){return n.installApp({name:t})});return Promise.all(o).then(function(t){return t.every(Boolean)}).then(function(t){return t&&r&&i&&r(i)})},a.prototype._getPrefixName=function(t){return t.domainName||(t.name&&t.name.includes(".")?this._getPrefixNameByDelimiter(t.name,"."):this._getPrefixNameByDelimiter(t.path,"/"))},a.prototype._getPrefixNameByDelimiter=function(t,e){var n=this;return(this.config.ignoreCase?t.toLowerCase():t).split(e).filter(function(t){return!Object.values(n.router.currentRoute.params).includes(t)}).filter(Boolean).map(function(t){return t.trim()}).shift()},a}(f);return T.version="1.0.4",T.DEFAULTS={ignoreCase:!0,parentPath:null,getNamespace:function(t){return"__domain__app__"+t}},T.LOAD_STATUS={SUCCESS:1,START:0,FAILED:-1},T.ERROR_CODE={LOAD_ERROR_HAPPENED:T.LOAD_STATUS.FAILED,LOAD_DUPLICATE_WITHOUT_PATH:-2,LOAD_APP_INIT_FAILED:-3},T},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("vue-router")):"function"==typeof define&&define.amd?define(["vue-router"],e):t.VueMfe=e(t.VueRouter);