/*!
  * vue-mfe v1.0.4
  * (c) 2019 Vuchan
  * @license MIT
  */
var t,e;t=this,e=function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e=function(){},n=function(t){return Array.isArray(t)},r=function(t){return t&&"function"==typeof t},o=function(t){return t&&"object"==typeof t},i=function(t){return"string"==typeof t},a=function(t){return Array.prototype.slice.call(t)},u="undefined"!=typeof console&&"function"==typeof console.warn;function s(t,e,n){return t?r(e)&&e():r(n)&&n()}var p=function(t){return function(n){return s(!1,function(){return u&&console.log.apply(null,t?[t].concat(a(n)):n)},e)}},c=function(t){return function(n){var r=u?console.warn:e;return s(!0,function(){r.apply(null,t?[[t].concat(a(n)).join(" > ")]:n)})}};function f(){this.events={}}function h(t){t&&t instanceof HTMLElement&&("function"==typeof t.remove?t.remove():t.parentNode.removeChild(t))}f.prototype.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this.events[t]},f.prototype.off=function(t,e){if(t){var n=this.events[t];if(n&&n.length)return e?n.filter(function(t){return t===e}):(delete this.events[t],!0)}else this.events={}},f.prototype.emit=function(t){for(var e=[],n=arguments.length-1;n-- >0;)e[n]=arguments[n+1];var r=this.events[t];if(r)return r.forEach(function(t){return t.apply(null,e)}),!0};var l=function(){this.cached={}};function d(t,e){void 0===t&&(t=[]);for(var n=0,r=null,o=t.length;n<o;){var i=t[n],a=i.path,u=i.children;if(a===e)return i;if(u&&u.length?(r=d(u,e),n++):n++,r)return r}}function m(t,e){return"/"===e&&"/"!==t&&t.startsWith("/")?y(t):y(e)+y(t)}function y(t){return(t="/"!==t?t.replace(/\/?$/,""):t)?function(t){return"/"===t.charAt(0)}(t)?t:"/"+t:"/"}function v(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&-1===e.indexOf(r)&&(n[r]=t[r]);return n}l.log=function(){return p("VueMfe."+l.name)(arguments)},l.warn=function(){return c("VueMfe."+l.name)(arguments)},l.prototype.load=function(t){var e=this,o=t.name;return this.getRouteEntry(o).then(function(t){var i=r(t)?t():t;return l.log("start to load "+o+" resources:",i),e.installResources((n(i)?i:[i]).filter(Boolean),e.getName(o))})},l.prototype.getRouteEntry=function(t){var e=this,n=this.cached[t];return n?Promise.resolve(n):Promise.resolve(this.getResource(t)).then(function(n){if(void 0===n&&(n={}),e.cached=Object.assign({},e.cached,n),n[t])return n[t];l.log("all resources",JSON.stringify(n)),l.warn("The App '"+t+"' cannot be found in method 'config.getResource()'")})},l.prototype.installResources=function(t,e){var r,o=t.filter(function(t){return t.endsWith(".css")}),i=t.filter(function(t){return t.endsWith(".js")});if(n(o)&&o.length&&Promise.all(o.map(function(t){return e=t,(n=document.createElement("link")).type="text/css",n.rel="stylesheet",n.charset="utf-8",n.href=e,n.setAttribute("force",!1),new Promise(function(t,e){var r=setTimeout(function(){return o(!0)},12e3);function o(t){clearTimeout(r),n.onerror=n.onload=n.onreadystatechange=null,t&&n&&h(n)}n.onload=function(){o(),t.apply(void 0,arguments)},n.onerror=function(){o(!0),e.apply(void 0,arguments)},document.head.appendChild(n)});var e,n})).catch(function(t){return l.warn(t)}),n(i)&&i.length)return(r=i.map(function(t){return function(){return function(t,e){var n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=t,n.async=!0,n.setAttribute("nonce","nonce"),new Promise(function(r,o){var i=setTimeout(function(){return s("Reject script "+t+": LOAD_SCRIPT_TIMEOUT")},12e3);function a(){clearTimeout(i),n.onerror=n.onload=n.onreadystatechange=null,h(n)}function u(){for(var t=arguments.length,n=Array(t);t--;)n[t]=arguments[t];a(),r.apply(void 0,[e?window[e]:void 0].concat(n))}function s(){a(),o.apply(void 0,arguments)}void 0!==n.readyState?n.onreadystatechange=function(t){"loaded"!==n.readyState&&"complete"!==n.readyState||e&&!window[e]?s("Unknown error happened",t):u()}:(n.onload=u,n.onerror=function(e){s("GET "+t+" net::ERR_CONNECTION_REFUSED",e)}),document.body.appendChild(n)})}(t,e)}}),r.reduce(function(t,e){return t.then(function(t){return e(t)}).catch(function(t){throw t})},Promise.resolve())).catch(function(t){throw t});l.warn("no any valid entry script be found in "+t)},l.prototype.getResource=function(t){return this.getConfig(t).getResource()},l.prototype.getName=function(t){return this.getConfig(t).getNamespace(t)},l.prototype.getConfig=function(t){return void 0===t&&(t="*"),this.configs[t]||this.configs["*"]},l.prototype.setConfig=function(t,e){return o(t)&&(e=t,t="*"),this.configs||(this.configs={}),this.configs[t]=e,this};var g,A=function(t){t.addRoutes!==this.addRoutes&&(t.addRoutes=this.addRoutes.bind(this)),this.router=t,this.routes=t.options.routes,this.pathMap={},this.pathList=[],this.appsMap={},this._init()};A.warn=function(){return c(A.name)(arguments)},A.prototype._init=function(){this.refreshAndCheckState(this.routes)},A.prototype.addRoutes=function(e,n,r){this.refreshAndCheckState(e,n),this.router.matcher=new t(this.normalizeOptions(this.adaptRouterOptions(r||this.router),{routes:e},n)).matcher},A.prototype.adaptRouterOptions=function(e){if(e){if(e instanceof t)return e.options;if(n(e))return{routes:e}}return{}},A.prototype.normalizeOptions=function(t,e,n){var r=t.routes;void 0===r&&(r=[]);var o=v(t,["routes"]),i=e.routes;void 0===i&&(i=[]);var a=v(e,["routes"]);return Object.assign({routes:this.mergeRoutes(r,i,n)},a,o)},A.prototype.mergeRoutes=function(t,e,n){var r=n;return e.forEach(function(e){if(i(e.parentPath)?(n=e.parentPath,delete e.parentPath):n=r,i(n))if(""===n)t.push(e);else{var o=d(t,n),a=e.path;o&&(o.children||(o.children=[])).push(Object.assign({},e,{path:n&&a.startsWith("/")?a=a.replace(/^\/*/,""):a}))}else t.push(e)}),t},A.prototype.refreshAndCheckState=function(t,e){var n=this;t.forEach(function(t){var r=t.path,o=t.parentPath,i=t.name,a=t.children,u=t.childrenApps;if(o?r=n.genParentPath(r,o,i):e&&(r=n.genParentPath(r,e,i)),r&&(n.pathExists(r)?A.warn("The path "+r+" in pathList has been existed"):n.pathList.push(r)),i&&(n.nameExists(i)?A.warn("The name "+i+" in pathMap has been existed"):n.pathMap[i]=r),u&&[].concat(u).forEach(function(t){if("object"==typeof t){var e=Object.entries(t).shift(),o=e[0],i=e[1];n.appsMap[m(i,r)]=o}else n.appsMap[m(t,r)]=appName}),a&&a.length)return n.refreshAndCheckState(a,r)})},A.prototype.genParentPath=function(t,e,n){return this.pathExists(e)?m(t,e):(A.warn("Cannot found the parent path "+e+" "+(n?"of "+n:"")+" in Vue-MFE MasterRouter"),"")},A.prototype.pathExists=function(t){return this.pathList.includes(t)},A.prototype.nameExists=function(t){return this.pathMap[t]},A.prototype.getChildrenApps=function(t){var e=this.appsMap[t];return e?[].concat(e):null},A.prototype.findRoute=function(t,e){var n=i(e)&&e||o(e)&&e.path;return n&&d(t||this.routes,n)||null};var E=function(e){function a(n){void 0===n&&(n={}),e.call(this),Vue||"undefined"==typeof window||!window.Vue||a.install.installed||a.install(window.Vue),n&&n.router&&n.router instanceof t||a.warn('Must pass the router property in "Vue.use(VueMfe, { router, config })"');var r=n.router,o=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&-1===e.indexOf(r)&&(n[r]=t[r]);return n}(n,["router"]);this.router=r,this.config=Object.assign({},a.DEFAULTS,o),this.installedApps={},this.helpers=new A(this.router),this.lazyloader=(new l).setConfig(this.config),this._init()}return e&&(a.__proto__=e),a.prototype=Object.create(e&&e.prototype),a.prototype.constructor=a,a.log=function(){return p(a.name)(arguments)},a.warn=function(){return c(a.name)(arguments)},a.install=function(t){if(!a.install.installed||g!==t)if(a.install.installed=!0,g=t,Number(t.version.split(".")[0])>=2)t.mixin({beforeCreate:n});else{var e=t.prototype._init;t.prototype._init=function(t){void 0===t&&(t={}),t.init=t.init?[n].concat(t.init):n,e.call(this,t)}}function n(){var t=this.$options;t.mfe?this.$mfe="function"==typeof t.mfe?t.mfe():t.mfe:t.parent&&t.parent.$mfe&&(this.$mfe=t.parent.$mfe)}},a.prototype._init=function(){var t=this;this.router.beforeEach(function(e,n,r){if(0!==e.matched.length&&0!==t.router.match(e.path).matched.length)return r();var o=t._getPrefixName(e),i={name:o,to:e,from:n,next:r};if(!t.isInstalled(o))return t.installApp(i);var u=t.helpers.getChildrenApps(e.path||e.fullPath);if(u&&u.length)return t._installChildrenApps(u,i);var s=new Error(o+" has been installed but it has no any path "+e.path);s.code=a.ERROR_CODE.LOAD_DUPLICATE_WITHOUT_PATH,t.emit("error",s,i)})},a.prototype.installApp=function(t){var e=this,n=t.name,r=t.next,o=t.to;if(this.isInstalled(n))return!0;this.installedApps[n]=a.LOAD_STATUS.START,this.emit("start",t);return this.loadAppEntry(t).then(function(t){return e.executeAppEntry(t)}).then(function(t){return e.installAppModule(t)}).then(function(i){return a.log("install app "+n+" success",i),i&&(e.installedApps[n]=a.LOAD_STATUS.SUCCESS,r&&o&&r(o),e.emit("end",t)),i}).catch(function(o){o instanceof Error||(o=new Error(o)),o.code||(o.code=a.ERROR_CODE.LOAD_ERROR_HAPPENED),e.installedApps[n]=a.LOAD_STATUS.FAILED,r&&r(!1),e.emit("error",o,t)})},a.prototype.loadAppEntry=function(t){return this.lazyloader.load("string"==typeof t?{name:t}:t)},a.prototype.executeAppEntry=function(t){t=function(t){return t&&t.default||t}(t);var e=this.router&&this.router.app;return r(t)?Promise.resolve(t(e)):n(t)?t:o(t)?r(t.init)&&Promise.resolve(t.init(e)):void 0},a.prototype.installAppModule=function(t){if(n(t))return t.length?(this.helpers.addRoutes(t,this.config.parentPath),!0):(a.warn("`Route[]` has no any valid item"),!1);var e=new Error("Module "+name+" initialize failed.");return t instanceof Error&&(e=t),e.code=a.ERROR_CODE.APP_INIT_FAILED,a.warn(e),!1},a.prototype.isInstalled=function(t){var e=t;return o(t)&&/\//.exec(t.path)?e=this._getPrefixName(t):i(t)&&/\//.exec(t)&&(e=this._getPrefixNameByDelimiter(t,"/")),this.installedApps[e]===a.LOAD_STATUS.SUCCESS},a.prototype.preinstall=function(t){return t&&this.installApp({name:t})},a.prototype._installChildrenApps=function(t,e){var n=this,r=e.next,o=e.to,i=t.map(function(t){return n.installApp({name:t})});return Promise.all(i).then(function(t){return t.every(Boolean)}).then(function(t){return t&&r&&o&&r(o)})},a.prototype._getPrefixName=function(t){return t.domainName||(t.name&&t.name.includes(".")?this._getPrefixNameByDelimiter(t.name,"."):this._getPrefixNameByDelimiter(t.path,"/"))},a.prototype._getPrefixNameByDelimiter=function(t,e){var n=this;return(this.config.ignoreCase?t.toLowerCase():t).split(e).filter(function(t){return!Object.values(n.router.currentRoute.params).includes(t)}).filter(Boolean).map(function(t){return t.trim()}).shift()},a}(f);return E.version="1.0.4",E.DEFAULTS={ignoreCase:!0,parentPath:null,getNamespace:function(t){return"__domain__app__"+t}},E.LOAD_STATUS={SUCCESS:1,START:0,FAILED:-1},E.ERROR_CODE={LOAD_ERROR_HAPPENED:E.LOAD_STATUS.FAILED,LOAD_DUPLICATE_WITHOUT_PATH:-2,APP_INIT_FAILED:-3},E},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("vue-router")):"function"==typeof define&&define.amd?define(["vue-router"],e):t.VueMfe=e(t.VueRouter);