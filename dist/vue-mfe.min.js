/*!
  * vue-mfe v0.0.1
  * (c) 2019 Vuchan
  * @license MIT
  */
var t,e;t=this,e=function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e=function(){},n=function(t){return Array.isArray(t)},r=function(t){return t&&"function"==typeof t},o=function(t){return t&&"object"==typeof t},i=function(t){return"string"==typeof t},u=function(t){return Array.prototype.slice.call(t)},a="undefined"!=typeof console&&"function"==typeof console.warn;function s(t,e,n){return t?r(e)&&e():r(n)&&n()}var c=function(t){return function(n){return s(!1,function(){return a&&console.log.apply(null,t?[t].concat(u(n)):n)},e)}},f=function(t){return function(n){var r=a?console.warn:e;return s(!0,function(){r.apply(null,t?[[t].concat(u(n)).join(" > ")]:n)})}};function h(){this.events={}}h.prototype.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this.events[t]},h.prototype.off=function(t,e){if(t){var n=this.events[t];if(n&&n.length)return e?n.filter(function(t){return t===e}):(delete this.events[t],!0)}else this.events={}},h.prototype.emit=function(t){for(var e=[],n=arguments.length-1;n-- >0;)e[n]=arguments[n+1];var r=this.events[t];if(r)return r.forEach(function(t){return t.apply(null,e)}),!0};var p=function(){this.cached={}};function l(t,e){void 0===t&&(t=[]);for(var n=0,r=null,o=t.length;n<o;){var i=t[n],u=i.path,a=i.children;if(u===e)return i;if(a&&a.length?(r=l(a,e),n++):n++,r)return r}}function d(t){return(t="/"!==t?t.replace(/\/?$/,""):t)?function(t){return"/"===t.charAt(0)}(t)?t:"/"+t:""}function y(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&-1===e.indexOf(r)&&(n[r]=t[r]);return n}p.log=function(){return c("VueMfe."+p.name)(arguments)},p.warn=function(){return f("VueMfe."+p.name)(arguments)},p.prototype.load=function(t){var e=this,o=t.name;return this.getRouteEntry(o).then(function(t){var i=r(t)?t():t;return p.log("getRouteEntry resource",i),e.installResources(n(i)?i:[i],e.getName(o))})},p.prototype.getRouteEntry=function(t){var e=this,n=this.cached[t];return n?Promise.resolve(n):Promise.resolve(this.getResource(t)).then(function(n){if(void 0===n&&(n={}),e.cached=Object.assign({},e.cached,n),n[t])return n[t];p.log("resources object",JSON.stringify(n)),p.warn("The '"+t+"' cannot be found in 'config.getResource()'")})},p.prototype.installResources=function(t,e){var r,o=t.filter(function(t){return t.endsWith(".css")}),i=t.filter(function(t){return t.endsWith(".js")});if(n(o)&&o.length&&Promise.all(o.map(function(t){return e=t,(n=document.createElement("link")).type="text/css",n.rel="stylesheet",n.charset="utf-8",n.href=e,n.setAttribute("force",!1),new Promise(function(t,e){var r=setTimeout(function(){return o(!0)},12e3);function o(t){clearTimeout(r),n.onerror=n.onload=n.onreadystatechange=null,t&&n&&n.remove()}n.onload=function(){o(),t.apply(void 0,arguments)},n.onerror=function(){o(!0),e.apply(void 0,arguments)},document.head.appendChild(n)});var e,n})).catch(function(t){return p.warn(t)}),n(i)&&i.length)return(r=i.map(function(t){return function(){return function(t,e){var n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=t,n.async=!0,n.setAttribute("nonce","nonce"),new Promise(function(r,o){var i=setTimeout(function(){return s("Reject script "+t+": LOAD_SCRIPT_TIMEOUT")},12e3);function u(){clearTimeout(i),n.onerror=n.onload=n.onreadystatechange=null,n.remove()}function a(){for(var t=arguments.length,n=Array(t);t--;)n[t]=arguments[t];u(),r.apply(void 0,[e?window[e]:void 0].concat(n))}function s(){u(),o.apply(void 0,arguments)}void 0!==n.readyState?n.onreadystatechange=function(t){"loaded"!==n.readyState&&"complete"!==n.readyState||e&&!window[e]?s("Unknown error happened",t):a()}:(n.onload=a,n.onerror=function(e){s("GET "+t+" net::ERR_CONNECTION_REFUSED",e)}),document.body.appendChild(n)})}(t,e)}}),r.reduce(function(t,e){return t.then(function(t){return e(t)}).catch(function(t){throw t})},Promise.resolve())).catch(function(t){throw t});p.warn("no any valid entry script be found in "+t)},p.prototype.getResource=function(t){return this.getConfig(t).getResource()},p.prototype.getName=function(t){return this.getConfig(t).getNamespace(t)},p.prototype.getConfig=function(t){return void 0===t&&(t="*"),this.configs[t]||this.configs["*"]},p.prototype.setConfig=function(t,e){return o(t)&&(e=t,t="*"),this.configs||(this.configs={}),this.configs[t]=e,this};var m=function(t){t.addRoutes!==this.addRoutes&&(t.addRoutes=this.addRoutes),this.router=t,this.routes=t.options.routes,this.pathMap={},this.pathList=[],this._init()};m.warn=function(){return f(m.name)(arguments)},m.prototype._init=function(){this.refreshAndCheckState(this.routes)},m.prototype.addRoutes=function(e,n){this.refreshAndCheckState(e,n),this.router.matcher=new t(this.normalizeOptions(this.router.options,{routes:e},n)).matcher},m.prototype.normalizeOptions=function(t,e,n){var r=t.routes,o=y(t,["routes"]),i=e.routes,u=y(e,["routes"]);return Object.assign({routes:this.mergeRoutes(r,i,n)},u,o)},m.prototype.mergeRoutes=function(t,e,n){var r=n;return e.forEach(function(e){if(i(e.parentPath)?(n=e.parentPath,delete e.parentPath):n=r,i(n))if(""===n)t.push(e);else{var o=l(t,n),u=e.path;o&&(o.children||(o.children=[])).push(Object.assign({},e,{path:n&&u.startsWith("/")?u=u.replace(/^\/*/,""):u}))}else t.push(e)}),t},m.prototype.refreshAndCheckState=function(t,e){var n=this;t.forEach(function(t){var r=t.path,o=t.parentPath,i=t.name,u=t.children;if(o?r=n.getParentPath(r,o,i):e&&(r=n.getParentPath(r,e,i)),r&&(n.pathExists(r)?m.warn("The path "+r+" in pathList has been existed"):n.pathList.push(r)),i&&(n.nameExists(i)?m.warn("The name "+i+" in pathMap has been existed"):n.pathMap[i]=r),u&&u.length)return n.refreshAndCheckState(u,r)})},m.prototype.getParentPath=function(t,e,n){return this.pathExists(e)?function(t,e){return"/"===e&&"/"!==t&&t.startsWith("/")?d(t):d(e)+d(t)}(t,e):(m.warn("Cannot found the parent path "+e+" "+(n?"of "+n:"")+" in Vue-MFE MasterRouter"),"")},m.prototype.pathExists=function(t){return this.pathList.includes(t)},m.prototype.nameExists=function(t){return this.pathMap[t]},m.prototype.findRoute=function(t){var e=i(t)&&t||o(t)&&t.path;return e&&l(this.routes,e)||null};var v=function(e){function u(n){void 0===n&&(n={}),e.call(this),n&&n.router&&n.router instanceof t||u.warn("Must pass the router property in 'Vue.use(VueMfe, { router, config })'");var r=n.router,o=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&-1===e.indexOf(r)&&(n[r]=t[r]);return n}(n,["router"]);this.router=r,this.config=Object.assign({},u.DEFAULTS,o),this.installedApps={},this._init()}return e&&(u.__proto__=e),u.prototype=Object.create(e&&e.prototype),u.prototype.constructor=u,u.log=function(){return c(u.name)(arguments)},u.warn=function(){return f(u.name)(arguments)},u.prototype._init=function(){var t=this;this.helpers=new m(this.router),this.lazyloader=(new p).setConfig(this.config),this.router.beforeEach(function(e,n,r){if(0===e.matched.length||0===t.router.match(e.path).matched.length){var o=t._getPrefixName(e),i={name:o,to:e,from:n,next:r};if(t.isInstalled(o)){var a=new Error(o+" has been installed but it does not have path "+e.path);a.code=u.ERROR_CODE.LOAD_DUPLICATE_WITHOUT_PATH,t.emit("error",a,i)}else t.installApp(i)}else r()})},u.prototype.installApp=function(t){var e=this,n=t.name,r=t.next,o=t.to;return this.installedApps[n]=u.LOAD_STATUS.START,this.emit("start",t),this.lazyloader.load(t).then(function(t){return u.log("installApp module",t),e.installModule(t)}).then(function(i){u.log("installApp success",i),i&&(e.installedApps[n]=u.LOAD_STATUS.SUCCESS,r&&o&&r(o),e.emit("end",t))}).catch(function(o){o instanceof Error||(o=new Error(o)),o.code||(o.code=u.ERROR_CODE.LOAD_ERROR_HAPPENED),e.installedApps[n]=u.LOAD_STATUS.FAILED,r&&r(!1),e.emit("error",o,t)})},u.prototype.installModule=function(t){var e=this;t=function(t){return t&&t.default||t}(t);var i=this.router.app||{};return!!t&&(r(t)?Promise.resolve(t(i)).then(function(t){return e._checkRoutes(t)}):n(t)?this.addRoutes(t):o(t)?r(t.init)&&Promise.resolve(t.init(i)).then(function(n){return!1===n||n instanceof Error?e._checkRoutes(n):e.addRoutes(t.routes)}):void 0)},u.prototype.addRoutes=function(t,e){if(t){if(t.length)return this.helpers.addRoutes(t,e||this.config.parentPath),!0;u.warn("Routes has no any valid item")}else u.warn("Must pass a valid 'routes: Array<Route>' in `addRoutes` method");return!1},u.prototype.isInstalled=function(t){var e=t;return o(t)&&/\//.exec(t.path)?e=this._getPrefixName(t):i(t)&&/\//.exec(t)&&(e=this._getPrefixNameByDelimiter(t,"/")),this.installedApps[e]===u.LOAD_STATUS.SUCCESS},u.prototype.preinstall=function(t){return t&&this.installApp({name:t})},u.prototype._getPrefixName=function(t){return t.name&&t.name.includes(".")?this._getPrefixNameByDelimiter(t.name,"."):this._getPrefixNameByDelimiter(t.path,"/")},u.prototype._getPrefixNameByDelimiter=function(t,e){var n=this;return(this.config.ignoreCase?t.toLowerCase():t).split(e).filter(function(t){return!Object.values(n.router.currentRoute.params).includes(t)}).filter(Boolean).map(function(t){return t.trim()}).shift()},u.prototype._checkRoutes=function(t){if(t)return this.addRoutes(t);if(t instanceof Error)throw t.code=u.ERROR_CODE.APP_INIT_FAILED,t;return u.warn("Module "+name+" initialize failed."),!1},u}(h);return v.version="0.0.1",v.DEFAULTS={ignoreCase:!0,parentPath:null,getNamespace:function(t){return"__domain__app__"+t}},v.LOAD_STATUS={SUCCESS:1,START:0,FAILED:-1},v.ERROR_CODE={LOAD_ERROR_HAPPENED:v.LOAD_STATUS.FAILED,LOAD_DUPLICATE_WITHOUT_PATH:-2,APP_INIT_FAILED:-3},v},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("vue-router")):"function"==typeof define&&define.amd?define(["vue-router"],e):t.VueMfe=e(t.VueRouter);