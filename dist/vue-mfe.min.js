/*!
  * vue-mfe v0.0.1
  * (c) 2019 Vuchan
  * @license MIT
  */
var t,e;t=this,e=function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e=function(){},n=function(t){return Array.isArray(t)},r=function(t){return t&&"function"==typeof t},o=function(t){return t&&"object"==typeof t},i=function(t){return"string"==typeof t},a=function(t){return Array.prototype.slice.call(t)},u="undefined"!=typeof console&&"function"==typeof console.warn;function s(t,e,n){return t?r(e)&&e():r(n)&&n()}var c=function(t){return function(n){return s(!1,function(){return u&&console.log.apply(null,t?[t].concat(a(n)):n)},e)}},f=function(t){return function(n){var r=u?console.warn:e;return s(!0,function(){r.apply(null,t?[[t].concat(a(n)).join(" > ")]:n)})}};function p(){this.events={}}p.prototype.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this.events[t]},p.prototype.off=function(t,e){if(t){var n=this.events[t];if(n&&n.length)return e?n.filter(function(t){return t===e}):(delete this.events[t],!0)}else this.events={}},p.prototype.emit=function(t){for(var e=[],n=arguments.length-1;n-- >0;)e[n]=arguments[n+1];var r=this.events[t];if(r)return r.forEach(function(t){return t.apply(null,e)}),!0};var h=function(){this.cached={}};function l(t,e){void 0===t&&(t=[]);for(var n=0,r=null,o=t.length;n<o;){var i=t[n],a=i.path,u=i.children;if(a===e)return i;if(u&&u.length?(r=l(u,e),n++):n++,r)return r}}function d(t){return(t="/"!==t?t.replace(/\/?$/,""):t)?function(t){return"/"===t.charAt(0)}(t)?t:"/"+t:""}function m(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&-1===e.indexOf(r)&&(n[r]=t[r]);return n}h.log=function(){return c("VueMfe."+h.name)(arguments)},h.warn=function(){return f("VueMfe."+h.name)(arguments)},h.prototype.load=function(t){var e=this,o=t.name;return this.getRouteEntry(o).then(function(t){var i=r(t)?t():t;return h.log("getRouteEntry resource",i),e.installResources(n(i)?i:[i],e.getName(o))})},h.prototype.getRouteEntry=function(t){var e=this,n=this.cached[t];return n?Promise.resolve(n):Promise.resolve(this.getResource(t)).then(function(n){if(void 0===n&&(n={}),e.cached=Object.assign({},e.cached,n),n[t])return n[t];h.log("resources object",JSON.stringify(n)),h.warn("The '"+t+"' cannot be found in 'config.getResource()'")})},h.prototype.installResources=function(t,e){var r,o=t.filter(function(t){return t.endsWith(".css")}),i=t.filter(function(t){return t.endsWith(".js")});if(n(o)&&o.length&&Promise.all(o.map(function(t){return e=t,(n=document.createElement("link")).type="text/css",n.rel="stylesheet",n.charset="utf-8",n.href=e,n.setAttribute("force",!1),new Promise(function(t,e){var r=setTimeout(function(){return o(!0)},12e3);function o(t){clearTimeout(r),n.onerror=n.onload=n.onreadystatechange=null,t&&n&&n.remove()}n.onload=function(){o(),t.apply(void 0,arguments)},n.onerror=function(){o(!0),e.apply(void 0,arguments)},document.head.appendChild(n)});var e,n})).catch(function(t){return h.warn(t)}),n(i)&&i.length)return(r=i.map(function(t){return function(){return function(t,e){var n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=t,n.async=!0,n.setAttribute("nonce","nonce"),new Promise(function(r,o){var i=setTimeout(function(){return s("Reject script "+t+": LOAD_SCRIPT_TIMEOUT")},12e3);function a(){clearTimeout(i),n.onerror=n.onload=n.onreadystatechange=null,n.remove()}function u(){for(var t=arguments.length,n=Array(t);t--;)n[t]=arguments[t];a(),r.apply(void 0,[e?window[e]:void 0].concat(n))}function s(){a(),o.apply(void 0,arguments)}void 0!==n.readyState?n.onreadystatechange=function(t){"loaded"!==n.readyState&&"complete"!==n.readyState||e&&!window[e]?s("Unknown error happened",t):u()}:(n.onload=u,n.onerror=function(e){s("GET "+t+" net::ERR_CONNECTION_REFUSED",e)}),document.body.appendChild(n)})}(t,e)}}),r.reduce(function(t,e){return t.then(function(t){return e(t)}).catch(function(t){throw t})},Promise.resolve())).catch(function(t){throw t});h.warn("no any valid entry script be found in "+t)},h.prototype.getResource=function(t){return this.getConfig(t).getResource()},h.prototype.getName=function(t){return this.getConfig(t).getNamespace(t)},h.prototype.getConfig=function(t){return void 0===t&&(t="*"),this.configs[t]||this.configs["*"]},h.prototype.setConfig=function(t,e){return o(t)&&(e=t,t="*"),this.configs||(this.configs={}),this.configs[t]=e,this};var y,v=function(t){t.addRoutes!==this.addRoutes&&(t.addRoutes=this.addRoutes),this.router=t,this.routes=t.options.routes,this.pathMap={},this.pathList=[],this._init()};v.warn=function(){return f(v.name)(arguments)},v.prototype._init=function(){this.refreshAndCheckState(this.routes)},v.prototype.addRoutes=function(e,n){this.refreshAndCheckState(e,n),this.router.matcher=new t(this.normalizeOptions(this.router.options,{routes:e},n)).matcher},v.prototype.normalizeOptions=function(t,e,n){var r=t.routes,o=m(t,["routes"]),i=e.routes,a=m(e,["routes"]);return Object.assign({routes:this.mergeRoutes(r,i,n)},a,o)},v.prototype.mergeRoutes=function(t,e,n){var r=n;return e.forEach(function(e){if(i(e.parentPath)?(n=e.parentPath,delete e.parentPath):n=r,i(n))if(""===n)t.push(e);else{var o=l(t,n),a=e.path;o&&(o.children||(o.children=[])).push(Object.assign({},e,{path:n&&a.startsWith("/")?a=a.replace(/^\/*/,""):a}))}else t.push(e)}),t},v.prototype.refreshAndCheckState=function(t,e){var n=this;t.forEach(function(t){var r=t.path,o=t.parentPath,i=t.name,a=t.children;if(o?r=n.getParentPath(r,o,i):e&&(r=n.getParentPath(r,e,i)),r&&(n.pathExists(r)?v.warn("The path "+r+" in pathList has been existed"):n.pathList.push(r)),i&&(n.nameExists(i)?v.warn("The name "+i+" in pathMap has been existed"):n.pathMap[i]=r),a&&a.length)return n.refreshAndCheckState(a,r)})},v.prototype.getParentPath=function(t,e,n){return this.pathExists(e)?function(t,e){return"/"===e&&"/"!==t&&t.startsWith("/")?d(t):d(e)+d(t)}(t,e):(v.warn("Cannot found the parent path "+e+" "+(n?"of "+n:"")+" in Vue-MFE MasterRouter"),"")},v.prototype.pathExists=function(t){return this.pathList.includes(t)},v.prototype.nameExists=function(t){return this.pathMap[t]},v.prototype.findRoute=function(t){var e=i(t)&&t||o(t)&&t.path;return e&&l(this.routes,e)||null};var g=function(e){function a(n){void 0===n&&(n={}),e.call(this),Vue||"undefined"==typeof window||!window.Vue||a.install.installed||a.install(window.Vue),n&&n.router&&n.router instanceof t||a.warn('Must pass the router property in "Vue.use(VueMfe, { router, config })"');var r=n.router,o=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&-1===e.indexOf(r)&&(n[r]=t[r]);return n}(n,["router"]);this.router=r,this.config=Object.assign({},a.DEFAULTS,o),this.installedApps={},this._init()}return e&&(a.__proto__=e),a.prototype=Object.create(e&&e.prototype),a.prototype.constructor=a,a.log=function(){return c(a.name)(arguments)},a.warn=function(){return f(a.name)(arguments)},a.install=function(t){if(!a.install.installed||y!==t)if(a.install.installed=!0,y=t,Number(t.version.split(".")[0])>=2)t.mixin({beforeCreate:n});else{var e=t.prototype._init;t.prototype._init=function(t){void 0===t&&(t={}),t.init=t.init?[n].concat(t.init):n,e.call(this,t)}}function n(){var t=this.$options;t.mfe?this.$mfe="function"==typeof t.mfe?t.mfe():t.mfe:t.parent&&t.parent.$mfe&&(this.$mfe=t.parent.$mfe)}},a.prototype._init=function(){var t=this;this.helpers=new v(this.router),this.lazyloader=(new h).setConfig(this.config),this.router.beforeEach(function(e,n,r){if(0===e.matched.length||0===t.router.match(e.path).matched.length){var o=t._getPrefixName(e),i={name:o,to:e,from:n,next:r};if(t.isInstalled(o)){var u=new Error(o+" has been installed but it does not have path "+e.path);u.code=a.ERROR_CODE.LOAD_DUPLICATE_WITHOUT_PATH,t.emit("error",u,i)}else t.installApp(i)}else r()})},a.prototype.installApp=function(t){var e=this,n=t.name,r=t.next,o=t.to;return this.installedApps[n]=a.LOAD_STATUS.START,this.emit("start",t),this.lazyloader.load(t).then(function(t){return a.log("installApp module",t),e.installModule(t)}).then(function(i){a.log("installApp success",i),i&&(e.installedApps[n]=a.LOAD_STATUS.SUCCESS,r&&o&&r(o),e.emit("end",t))}).catch(function(o){o instanceof Error||(o=new Error(o)),o.code||(o.code=a.ERROR_CODE.LOAD_ERROR_HAPPENED),e.installedApps[n]=a.LOAD_STATUS.FAILED,r&&r(!1),e.emit("error",o,t)})},a.prototype.installModule=function(t){var e=this;t=function(t){return t&&t.default||t}(t);var i=this.router.app||{};return!!t&&(r(t)?Promise.resolve(t(i)).then(function(t){return e._checkRoutes(t)}):n(t)?this.addRoutes(t):o(t)?r(t.init)&&Promise.resolve(t.init(i)).then(function(n){return!1===n||n instanceof Error?e._checkRoutes(n):e.addRoutes(t.routes)}):void 0)},a.prototype.addRoutes=function(t,e){if(t){if(t.length)return this.helpers.addRoutes(t,e||this.config.parentPath),!0;a.warn("Routes has no any valid item")}else a.warn('Must pass a valid "routes: Array<Route>" in "addRoutes" method');return!1},a.prototype.isInstalled=function(t){var e=t;return o(t)&&/\//.exec(t.path)?e=this._getPrefixName(t):i(t)&&/\//.exec(t)&&(e=this._getPrefixNameByDelimiter(t,"/")),this.installedApps[e]===a.LOAD_STATUS.SUCCESS},a.prototype.preinstall=function(t){return t&&this.installApp({name:t})},a.prototype._getPrefixName=function(t){return t.name&&t.name.includes(".")?this._getPrefixNameByDelimiter(t.name,"."):this._getPrefixNameByDelimiter(t.path,"/")},a.prototype._getPrefixNameByDelimiter=function(t,e){var n=this;return(this.config.ignoreCase?t.toLowerCase():t).split(e).filter(function(t){return!Object.values(n.router.currentRoute.params).includes(t)}).filter(Boolean).map(function(t){return t.trim()}).shift()},a.prototype._checkRoutes=function(t){if(t)return this.addRoutes(t);if(t instanceof Error)throw t.code=a.ERROR_CODE.APP_INIT_FAILED,t;return a.warn("Module "+name+" initialize failed."),!1},a}(p);return g.version="0.0.1",g.DEFAULTS={ignoreCase:!0,parentPath:null,getNamespace:function(t){return"__domain__app__"+t}},g.LOAD_STATUS={SUCCESS:1,START:0,FAILED:-1},g.ERROR_CODE={LOAD_ERROR_HAPPENED:g.LOAD_STATUS.FAILED,LOAD_DUPLICATE_WITHOUT_PATH:-2,APP_INIT_FAILED:-3},g},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("vue-router")):"function"==typeof define&&define.amd?define(["vue-router"],e):t.VueMfe=e(t.VueRouter);