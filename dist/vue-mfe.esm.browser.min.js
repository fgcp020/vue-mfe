/*!
  * vue-mfe v1.0.0
  * (c) 2019 Vuchan
  * @license MIT
  */
import t from"vue-router";const e=!1,n=()=>{},s=t=>Array.isArray(t),r=t=>t&&"function"==typeof t,i=t=>t&&"object"==typeof t,o=t=>"string"==typeof t,a=t=>Array.prototype.slice.call(t),h="undefined"!=typeof console&&"function"==typeof console.warn;function u(t,e,n){return t?r(e)&&e():r(n)&&n()}const c=t=>s=>u(e,()=>h&&console.log.apply(null,t?[t,...a(s)]:s),n),l=t=>s=>{const r=e?t=>{throw new Error(t)}:h?console.warn:n;return u(!0,()=>{r.apply(null,t?[[t,...a(s)].join(" > ")]:s)})},p=t=>t&&t.default||t,f=t=>t.reduce((t,e)=>t.then(t=>e(t)).catch(t=>{throw t}),Promise.resolve());function d(){this.events={}}d.prototype.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this.events[t]},d.prototype.off=function(t,e){if(t){let n=this.events[t];if(n&&n.length)return e?n=n.filter(t=>t===e):(delete this.events[t],!0)}else this.events={}},d.prototype.emit=function(t,...e){const n=this.events[t];if(n)return n.forEach(t=>t.apply(null,e)),!0};class m{static log(){return c("VueMfe."+m.name)(arguments)}static warn(){return l("VueMfe."+m.name)(arguments)}constructor(){this.cached={}}load({name:t}){return this.getRouteEntry(t).then(n=>{const o=r(n)?n():n;return m.log("getRouteEntry resource",o),e&&i(o)&&!s(o)?o:this.installResources(s(o)?o:[o],this.getName(t))})}getRouteEntry(t){let e=this.cached[t];return e?Promise.resolve(e):Promise.resolve(this.getResource(t)).then((e={})=>{if(this.cached=Object.assign({},this.cached,e),e[t])return e[t];m.log("resources object",JSON.stringify(e)),m.warn(`The '${t}' cannot be found in 'config.getResource()'`)})}installResources(t,e){const n=t.filter(t=>t.endsWith(".css")),r=t.filter(t=>t.endsWith(".js"));if(s(n)&&n.length&&Promise.all(n.map(t=>(function(t){const e=document.createElement("link");return e.type="text/css",e.rel="stylesheet",e.charset="utf-8",e.href=t,e.setAttribute("force",!1),new Promise((t,n)=>{let s=setTimeout(()=>r(!0),12e3);function r(t){clearTimeout(s),e.onerror=e.onload=e.onreadystatechange=null,t&&e&&e.remove()}e.onload=function(){r(),t(...arguments)},e.onerror=function(){r(!0),n(...arguments)},document.head.appendChild(e)})})(t))).catch(t=>m.warn(t)),s(r)&&r.length)return f(r.map(t=>()=>(function(t,e){const n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=t,n.async=!0,n.setAttribute("nonce","nonce"),new Promise((s,r)=>{let i=setTimeout(()=>h(`Reject script ${t}: LOAD_SCRIPT_TIMEOUT`),12e3);function o(){clearTimeout(i),n.onerror=n.onload=n.onreadystatechange=null,n.remove()}function a(){o(),s(e?window[e]:void 0,...arguments)}function h(){o(),r(...arguments)}void 0!==n.readyState?n.onreadystatechange=function(t){"loaded"!==n.readyState&&"complete"!==n.readyState||e&&!window[e]?h("Unknown error happened",t):a()}:(n.onload=a,n.onerror=function(e){h(`GET ${t} net::ERR_CONNECTION_REFUSED`,e)}),document.body.appendChild(n)})})(t,e))).catch(t=>{throw t});m.warn(`no any valid entry script be found in ${t}`)}getResource(t){return this.getConfig(t).getResource()}getName(t){return this.getConfig(t).getNamespace(t)}getConfig(t="*"){return this.configs[t]||this.configs["*"]}setConfig(t,e){return i(t)&&(e=t,t="*"),this.configs||(this.configs={}),this.configs[t]=e,this}}function g(t=[],e){let n=0,s=null;const r=t.length;for(;n<r;){const r=t[n],{path:i,children:o}=r;if(i===e)return r;if(o&&o.length?(s=g(o,e),n++):n++,s)return s}}function A(t){return(t="/"!==t?t.replace(/\/?$/,""):t)?function(t){return"/"===t.charAt(0)}(t)?t:"/"+t:"/"}class R{static warn(){return l(R.name)(arguments)}constructor(t){t.addRoutes!==this.addRoutes&&(t.addRoutes=this.addRoutes),this.router=t,this.routes=t.options.routes,this.pathMap={},this.pathList=[],this._init()}_init(){this.refreshAndCheckState(this.routes)}addRoutes(e,n){this.refreshAndCheckState(e,n),this.router.matcher=new t(this.normalizeOptions(this.router.options,{routes:e},n)).matcher}normalizeOptions(t,e,n){const{routes:s,...r}=t,{routes:i,...o}=e;return Object.assign({routes:this.mergeRoutes(s,i,n)},o,r)}mergeRoutes(t,e,n){const s=n;return e.forEach(e=>{if(o(e.parentPath)?(n=e.parentPath,delete e.parentPath):n=s,o(n))if(""===n)t.push(e);else{const s=g(t,n);let r=e.path;s&&(s.children||(s.children=[])).push(Object.assign({},e,{path:n&&r.startsWith("/")?r=r.replace(/^\/*/,""):r}))}else t.push(e)}),t}refreshAndCheckState(t,e){t.forEach(({path:t,parentPath:n,name:s,children:r})=>{if(n?t=this.getParentPath(t,n,s):e&&(t=this.getParentPath(t,e,s)),t&&(this.pathExists(t)?R.warn(`The path ${t} in pathList has been existed`):this.pathList.push(t)),s&&(this.nameExists(s)?R.warn(`The name ${s} in pathMap has been existed`):this.pathMap[s]=t),r&&r.length)return this.refreshAndCheckState(r,t)})}getParentPath(t,e,n){return this.pathExists(e)?function(t,e){return"/"===e&&"/"!==t&&t.startsWith("/")?A(t):A(e)+A(t)}(t,e):(R.warn(`Cannot found the parent path ${e} ${n?"of "+n:""} in Vue-MFE MasterRouter`),"")}pathExists(t){return this.pathList.includes(t)}nameExists(t){return this.pathMap[t]}findRoute(t){let e=o(t)&&t||i(t)&&t.path;return e&&g(this.routes,e)||null}}let E;class _ extends d{static log(){return c(_.name)(arguments)}static warn(){return l(_.name)(arguments)}static install(t){if(_.install.installed&&E===t)return;if(_.install.installed=!0,E=t,Number(t.version.split(".")[0])>=2)t.mixin({beforeCreate:e});else{const n=t.prototype._init;t.prototype._init=function(t={}){t.init=t.init?[e].concat(t.init):e,n.call(this,t)}}function e(){const t=this.$options;t.mfe?this.$mfe="function"==typeof t.mfe?t.mfe():t.mfe:t.parent&&t.parent.$mfe&&(this.$mfe=t.parent.$mfe)}}constructor(e={}){super(),Vue||"undefined"==typeof window||!window.Vue||_.install.installed||_.install(window.Vue),e&&e.router&&e.router instanceof t||_.warn('Must pass the router property in "Vue.use(VueMfe, { router, config })"');const{router:n,...s}=e;this.router=n,this.config=Object.assign({},_.DEFAULTS,s),this.installedApps={},this._init()}_init(){this.helpers=new R(this.router),this.lazyloader=(new m).setConfig(this.config),this.router.beforeEach((t,e,n)=>{if(0===t.matched.length||0===this.router.match(t.path).matched.length){const s=this._getPrefixName(t),r={name:s,to:t,from:e,next:n};if(this.isInstalled(s)){const e=new Error(`${s} has been installed but it does not have path ${t.path}`);e.code=_.ERROR_CODE.LOAD_DUPLICATE_WITHOUT_PATH,this.emit("error",e,r)}else this.installApp(r)}else n()})}installApp(t){const{name:e,next:n,to:s}=t;return this.installedApps[e]=_.LOAD_STATUS.START,this.emit("start",t),this.lazyloader.load(t).then(t=>(_.log("installApp module",t),this.installModule(t))).then(r=>{_.log("installApp success",r),r&&(this.installedApps[e]=_.LOAD_STATUS.SUCCESS,n&&s&&n(s),this.emit("end",t))}).catch(s=>{s instanceof Error||(s=new Error(s)),s.code||(s.code=_.ERROR_CODE.LOAD_ERROR_HAPPENED),this.installedApps[e]=_.LOAD_STATUS.FAILED,n&&n(!1),this.emit("error",s,t)})}installModule(t){t=p(t);const e=this.router.app||{};return!!t&&(r(t)?Promise.resolve(t(e)).then(t=>this._checkRoutes(t)):s(t)?this.addRoutes(t):i(t)?r(t.init)&&Promise.resolve(t.init(e)).then(e=>!1===e||e instanceof Error?this._checkRoutes(e):this.addRoutes(t.routes)):void 0)}addRoutes(t,e){if(t){if(t.length)return this.helpers.addRoutes(t,e||this.config.parentPath),!0;_.warn("Routes has no any valid item")}else _.warn('Must pass a valid "routes: Array<Route>" in "addRoutes" method');return!1}isInstalled(t){let e=t;return i(t)&&/\//.exec(t.path)?e=this._getPrefixName(t):o(t)&&/\//.exec(t)&&(e=this._getPrefixNameByDelimiter(t,"/")),this.installedApps[e]===_.LOAD_STATUS.SUCCESS}preinstall(t){return t&&this.installApp({name:t})}_getPrefixName(t){return t.name&&t.name.includes(".")?this._getPrefixNameByDelimiter(t.name,"."):this._getPrefixNameByDelimiter(t.path,"/")}_getPrefixNameByDelimiter(t,e){return(this.config.ignoreCase?t.toLowerCase():t).split(e).filter(t=>!Object.values(this.router.currentRoute.params).includes(t)).filter(Boolean).map(t=>t.trim()).shift()}_checkRoutes(t){if(t)return this.addRoutes(t);if(t instanceof Error)throw t.code=_.ERROR_CODE.APP_INIT_FAILED,t;return _.warn("Module "+name+" initialize failed."),!1}}_.version="1.0.0",_.DEFAULTS={ignoreCase:!0,parentPath:null,getNamespace:t=>`__domain__app__${t}`},_.LOAD_STATUS={SUCCESS:1,START:0,FAILED:-1},_.ERROR_CODE={LOAD_ERROR_HAPPENED:_.LOAD_STATUS.FAILED,LOAD_DUPLICATE_WITHOUT_PATH:-2,APP_INIT_FAILED:-3};export default _;