/*!
  * vue-mfe v1.0.7
  * (c) 2019 Vuchan
  * @license MIT
  */
import e from"vue-router";const t=1,n={};function r(e){return n[e]===t}function o(e,t){return n[e]=t}const i=e=>Array.isArray(e),s=e=>e&&"function"==typeof e,c=e=>e&&"object"==typeof e,a=e=>"string"==typeof e,u=new Map,f=()=>d().router,l=()=>f().app,p=e=>d(e).globalVar||"__domain__app__"+e,h=e=>d(e).name,d=(e="*")=>u.get(e)||{},m=(e,t)=>(c(e)&&(e=(t=e).prefix||"*"),!(!a(e)||!c(t))&&u.set(e,t)),g=!1,y="undefined"!=typeof console&&"function"==typeof console.warn,w=function(){if(g)throw Error.apply(window,arguments);y&&console.warn.apply(arguments)};function v(e){e&&e instanceof HTMLElement&&("function"==typeof e.remove?e.remove():e.parentNode.removeChild(e))}const E=new Map;let $={};function x(e){return $[e]||b(e).then(t=>{const n=s(t)?t():t;try{return g&&c(n)&&!i(n)?n:$[e]=P((i(n)?n:[n]).filter(Boolean),p(e))}catch(e){throw console.log("error: ",e),new Error(e)}})}const b=e=>Promise.resolve((e=>{const t=E.get(e);if(t&&c(t))return t;let n=d(e);if(n&&n.resources||(n=d()),n&&n.resources){if(s(n.resources)){const t=n.resources();return E.set(e,t),t}if(c(n.resources)){const t=n.resources;return E.set(e,t),t}}})(e)).then(t=>t&&t[e]||w(`The App key '${e}' cannot be found in ${JSON.stringify(t)}`)),P=(e,t)=>{const n=e.filter(e=>e.endsWith(".css")),r=e.filter(e=>e.endsWith(".js"));if(i(n)&&n.length&&Promise.all(n.map(e=>(function(e){const t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.charset="utf-8",t.href=e,t.setAttribute("force",!1),new Promise((e,n)=>{let r=setTimeout(()=>o(!0),12e3);function o(e){clearTimeout(r),t.onerror=t.onload=t.onreadystatechange=null,e&&t&&v(t)}t.onload=function(){o(),e(...arguments)},t.onerror=function(){o(!0),n(...arguments)},document.head.appendChild(t)})})(e))).catch(w),i(r)&&r.length)return O(r.map(e=>()=>(function(e,t){const n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=e,n.async=!0,n.setAttribute("nonce","nonce"),new Promise((r,o)=>{let i=setTimeout(()=>a(`Reject script ${e}: LOAD_SCRIPT_TIMEOUT`),12e3);function s(){clearTimeout(i),n.onerror=n.onload=n.onreadystatechange=null,v(n)}function c(){s(),r(t?window[t]:void 0,...arguments)}function a(){s(),o(...arguments)}void 0!==n.readyState?n.onreadystatechange=function(e){"loaded"!==n.readyState&&"complete"!==n.readyState||t&&!window[t]?a("Unknown error happened",e):c()}:(n.onload=c,n.onerror=function(t){a(`GET ${e} net::ERR_CONNECTION_REFUSED`,t)}),document.body.appendChild(n)})})(e,t))).catch(e=>{w(e)});w(`No any valid script be found in ${e}`)},O=e=>e.reduce((e,t)=>e.then(e=>t(e)).catch(e=>{throw e}),Promise.resolve()),R="load-error";function T(e,t,n,r,o){e&&e instanceof Error||(e=new Error(`\u3010${h(r)||r}\u3011\uff1a`+t)),n&&!e.code&&(e.code=n),r&&!e.name&&(e.name=r),l().$emit(R,e,o)}function A(e){return e&&c(e)&&e.path&&e.component}const _="LOAD_ERROR_HAPPENED",j="LOAD_DUPLICATE_WITHOUT_PATH",M=e=>{const{name:n,next:a,to:u}=e;if(r(n))return!0;const p=l();o(n,0),p.$emit("load-start",e);return x(n).then(e=>(function(e,t){if(c(e)&&A(e))return f().addRoutes([e]);if(i(e)&&e.every(A))return f().addRoutes(e);const n=C(e),{parentPath:r}=d();if(c(n)){const{init:e,routes:t,parentPath:o}=n;return Promise.resolve(s(e)&&e(l())).then(()=>{f().addRoutes(t,o||r)})}throw new Error(`\n      Cannot not found 'export default VueMfe.createSubApp({ prefix: ${t}, routes: [] })' in '${t}/src/portal.entry.js'\n    `)})(e,n)).then(()=>(o(n,t),p.$emit("load-success",e),a&&u&&a(u),!0)).catch(t=>{o(n,-1),T(t,"",_,n,e),a&&a(!1)})};const C=e=>e&&e.default||e;const S=(e,t="/")=>e.split(t).map(e=>e.trim()).filter(Boolean).shift();function L(e,t="."){if(!d())throw new Error("Before you call `VueMfe.Lazy(url: string)` must set its config by `VueMfe.Lazy.setConfig({ resource: Resource[] })`");const n=S(e,t),r=e.slice(n.length+t.length);return n&&x(n).then(e=>{const t=N(C(e),r);return s(t)?t():t})}L.setConfig=function(e){return m(e)};const N=(e,t)=>t.split(".").reduce((e,t)=>e[t],e);var V=function(e,t){var n,r=[],o=0,i=0,s="",c=t&&t.delimiter||D,a=t&&t.whitelist||void 0,u=!1;for(;null!==(n=I.exec(e));){var f=n[0],l=n[1],p=n.index;if(s+=e.slice(i,p),i=p+f.length,l)s+=l[1],u=!0;else{var h="",d=n[2],m=n[3],g=n[4],y=n[5];if(!u&&s.length){var w=s.length-1,v=s[w],E=!a||a.indexOf(v)>-1;E&&(h=v,s=s.slice(0,w))}s&&(r.push(s),s="",u=!1);var $="+"===y||"*"===y,x="?"===y||"*"===y,b=m||g,P=h||c;r.push({name:d||o++,prefix:h,delimiter:P,optional:x,repeat:$,pattern:b?U(b):"[^"+W(P===c?P:P+c)+"]+?"})}}(s||i<e.length)&&r.push(s+e.substr(i));return r},k=function(e,t,n){for(var r=(n=n||{}).strict,o=!1!==n.start,i=!1!==n.end,s=n.delimiter||D,c=[].concat(n.endsWith||[]).map(W).concat("$").join("|"),a=o?"^":"",u=0;u<e.length;u++){var f=e[u];if("string"==typeof f)a+=W(f);else{var l=f.repeat?"(?:"+f.pattern+")(?:"+W(f.delimiter)+"(?:"+f.pattern+"))*":f.pattern;t&&t.push(f),f.optional?f.prefix?a+="(?:"+W(f.prefix)+"("+l+"))?":a+="("+l+")?":a+=W(f.prefix)+"("+l+")"}}if(i)r||(a+="(?:"+W(s)+")?"),a+="$"===c?"$":"(?="+c+")";else{var p=e[e.length-1],h="string"==typeof p?p[p.length-1]===s:void 0===p;r||(a+="(?:"+W(s)+"(?="+c+"))?"),h||(a+="(?="+W(s)+"|"+c+")")}return new RegExp(a,function(e){return e&&e.sensitive?"":"i"}(n))},D="/",I=new RegExp(["(\\\\.)","(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?"].join("|"),"g");function W(e){return e.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function U(e){return e.replace(/([=!:$\/()])/g,"\\$1")}function B(e,t){return"/"===t&&"/"!==e&&e.startsWith("/")?H(e):H(t)+H(e)}function H(e){return(e="/"!==e?e.replace(/\/?$/,""):e)?function(e){return"/"===e.charAt(0)}(e)?e:"/"+e:"/"}const z={},J=(e,t)=>{e&&[].concat(e).forEach(e=>{if("object"==typeof e){Object.keys(e).forEach(n=>{const r=e[n];z[B(r,t)]=n})}else z[B(e,t)]=name})},F=e=>{let t=z[e];if(!t){const n=function(e,t){const n=Object.keys(e);if(n){const e=n.map(e=>k(V(e)));let r=0,o=e.length;for(;r++<o;)if(e[r].test(t))return n[r]}}(z,e);n&&(t=z[n])}return t?[].concat(t):null},G=e=>{const t=e.map(e=>M({name:e}));return Promise.all(t).then(e=>e.every(Boolean))},q=[],K={},Q=e=>q.includes(e),X=e=>K[e],Y=(e,t,n)=>Q(t)?B(e,t):(w(`Cannot found the parent path ${t} ${n?"of "+n:""} in router`),"");function Z(e,t){e.forEach(({path:e,parentPath:n,name:r,children:o,childrenApps:i})=>{if(n?e=Y(e,n,r):t&&(e=Y(e,t,r)),e&&(Q(e)?w(`The path ${e} in pathList has been existed`):q.push(e)),r&&(X(r)?w(`The name ${r} in pathMap has been existed`):K[r]=e),J(i,e),o&&o.length)return Z(o,e)}),g&&(console.log(q),console.log(K))}function ee(t,n,r){Z(t,n),f().matcher=new e(function(e,t,n){const{routes:r=[],...o}=e,{routes:i=[],...s}=t;return Object.assign({routes:te(r,i,n)},s,o)}(function(t){if(t){if(t instanceof e)return t.options;if(i(t))return{routes:t}}return{}}(r||f()),{routes:t},n)).matcher}function te(e,t,n){const r=n;return t.forEach(t=>{if(a(t.parentPath)?(n=t.parentPath,delete t.parentPath):n=r,a(n))if(""===n)e.push(t);else{const r=function e(t=[],n){if(t){let r;for(let o=0;o<t.length;o++){if((r=t[o]).path===n)return r;if(r.children&&(r=e(r.children,n)))return r}}}(e,n);let o=t.path;r&&(r.children||(r.children=[])).push(Object.assign({},t,{path:n&&o.startsWith("/")?o=o.replace(/^\/*/,""):o}))}else e.push(t)}),e}function ne(e){e.beforeEach(function(e,t,n){if((i=e).name&&X(i.name)||Q(i.path)||0!==i.matched.length)return n();{const i=(o=e.fullPath||e.path,a(o)?S(o):c(o)?o.prefix:void 0),s={name:i,to:e,from:t,next:n};if(!r(i))return M(s);{const t=F(e.fullPath||e.path);if(t&&t.length)return function(e,t){const{next:n,to:r,name:o}=t;return G(e).then(e=>e&&n&&r&&n(r)).catch(e=>{T(e,"",_,o,t)})}(t,s);T(null,`${i} has been installed but it has no any path like ${e.path}`,j,i,s)}}var o,i})}const re={sensitive:!1,parentPath:"/",resources:()=>{throw new Error}};function oe(e){var t;m(Object.assign({},re,e)),(t=e.router).addRoutes!==ee&&(t.addRoutes=ee.bind(t)),Z(t.options.routes),ne(t)}function ie(e){if(!e.prefix)throw new Error(`Missing property 'prefix: string' in config \n${JSON.stringify(e)}`);if(!e.routes)throw new Error(`Missing property 'routes: Route[]' in config \n${JSON.stringify(e)}`);return m(e),e}const se={version:"1.0.7",Lazy:L,createApp:oe,createSubApp:ie,isInstalled:r};"undefined"==typeof window||!window.Vue||window.VueMfe&&window.VueMfe===se||(window.VueMfe=se);export default se;export{oe as createApp,ie as createSubApp};