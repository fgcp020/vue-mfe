/*!
  * vue-mfe v0.1.4
  * (c) 2019 Vuchan
  * @license MIT
  */
import e from"vue";import t from"vue-router";const n=e=>Array.isArray(e),r=e=>e&&"function"==typeof e,o=e=>e&&"object"==typeof e,a=e=>"string"==typeof e,i=(e,t=!1)=>e.split(/-|_|\s/g).map((e,n)=>t||0!==n?(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase())(e):e).join(""),u=e=>e&&e.default||e,s=e=>e.name&&e.name.includes(".")?c(e.name,"."):c(e.path,"/");function c(e,t){return e.split(t).filter(e=>!Object.values(GlobalPageRouter.currentRoute.params).includes(e)).filter(Boolean).map(e=>e.trim()).shift()}const l=(e,t,n)=>{Object.defineProperty(e,t,{value:n,configurable:!1,enumerable:!1,writable:!1})},f=e=>e.reduce((e,t)=>e.then(e=>t(e)).catch(e=>{throw e}),Promise.resolve());function h(e,t){const n=document.createElement("script");n.type="text/javascript",n.charset="utf-8",n.src=e,n.async=!0,n.setAttribute("nonce","nonce");let r=null,o=null;function a(){u(),r&&r(...arguments)}function i(){o&&o(t?window[t]:void 0),u()}function u(){clearTimeout(s),n.onerror=n.onload=n.onreadystatechange=null,n.remove()}document.body.appendChild(n);let s=setTimeout(()=>a(`Reject script ${e} error`),12e4);return new Promise((u,s)=>{o=u,r=s,void 0!==n.readyState?n.onreadystatechange=function(e){"loaded"!==n.readyState&&"complete"!==n.readyState||t&&!window[t]?a("Unknown error happened",e):i()}:(n.onload=function(){i()},n.onerror=function(t){a(`GET ${e} net::ERR_CONNECTION_REFUSED`,t)})})}const d=!1,p=!0;function m(e,t,n){return e?r(t)&&t():r(n)&&n()}function g(){return m(d,()=>console.info.apply(console,arguments))}function y(){const e=!d&&"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn||(e=>{throw new Error(e)});return m(!0,()=>{e.apply(this,arguments)})}function b(e){if(n(e))return k(e);if(o(e)){const{routes:t,mode:r,...o}=e;if(n(t)&&t.length)return k(t,o,r)}y("Must pass a valid routes array for `createMaster(config: { routes: Array<Route>, [props]: any }): Object<Master>>`")}e.use(t);let R=[],w={},v=null,$=[];const P=(e=[],n="history")=>{$&&$.length||($=e),function e(t=[],n=""){t.forEach(({path:t,name:r,children:o})=>{n&&(t=O(t,n)),r&&!w[r]&&(w[r]=t),t&&!R.includes(t)&&R.push(t),o&&o.length&&e(o,t)})}(e);let r=new t({routes:e,mode:n,scrollBehavior:(e,t,n)=>n||{x:0,y:0}});if(!v){v=r;const e=Object.create(null);l(e,"completePaths",O),l(e,"findRoute",M),l(e,"findPathName",x),l(e,"nameExists",S),l(e,"pathExists",A),l(v,"addRoutes",j),l(v,"helpers",e)}return r};function j(e=[],t="/"){let n=0;const r=[],o=e.filter(e=>e.parentPath?Boolean(++n):(r.push(e),!1)).filter(e=>!E(e));if(t&&r.length&&o.concat(r.filter(e=>!E(Object.assign(e,{parentPath:t})))),!n&&!t||0===o.length)return function(e){const t=P(e);return v.matcher=t.matcher,v}($);g("hasParentPathRouteLength: ",n),g("prependPath: ",t),g("unRegisteredRoutes: ",o),y(`Add routes failed, those routes ${JSON.stringify(o)} cannot be registered.`)}function E({path:e,name:t,parentPath:n,...r},o=$){const a=n?O(e,n):e,i=A(n?a:e),u=t&&S(t);m(i,()=>{const r=x(t),o=`\n      The path ${e} cannot be registered ${n?"to parentPath "+n:""},\n      because of it was already registered ${r?"in pathMap "+r:""}before.\n    `;m("/"===e,()=>d&&console.warn(o),()=>y(o))}),m(u,()=>y(`\n      The name ${t} cannot be registered to path ${e}\n      ${n?" with parentPath "+n:""}\n    },\n      because of it already registered in pathList ${u} before.\n    `));const s=Object.assign({path:"/"!==n&&e.startsWith("/")?e.replace(/^\/*/,""):e,name:t},r||{});if(n&&A(n)){const t=M(o,n);if(t)return t.children&&t.children.length?t.children.push(s):t.children=[s],!0;y(`Register path '${e}' failed, cannot found parent path '${n}',\n        Are you sure the parent path exists in MasterRouter/routes before?`)}else void 0!==n&&"string"==typeof n?o.push(s):y(`Register path '${e}' failed, parentPath '${n} does not exist'`)}function M(e=[],t){let n=0,r=null;const o=e.length;for(;n<o;){const o=e[n],{path:a,children:i}=o;if(a===t)return o;if(i&&i.length?(r=M(i,t),n++):n++,r)return r}}function O(e,t){return"/"===t&&"/"!==e&&e.startsWith("/")?_(e):_(t)+_(e)}function _(e){return(e="/"!==e?e.replace(/\/?$/,""):e)?function(e){return"/"===e.charAt(0)}(e)?e:"/"+e:""}function A(e){return R.includes(e)}function S(e){return w[e]}function x(e){return Object.keys(w).find(t=>w[t]===e)}function N(){return v}function T(){return $}let C=null;function L(e,t){const u=i(s(e)),c=B()||{},{onLoadStart:l,onLoadSuccess:p,onLoadError:m,getNamespace:b=(()=>`__domain__app__${u}`)}=c;return r(l)&&l(u,c),g("app-name: ",u),function(e,t){return C&&C[e]?Promise.resolve(C[e]):function(){const e=B();try{return e&&e.getResource&&e.getResource()}catch(e){return Promise.reject(e)}}().then(n=>n?(C=Object.assign({},C,n))[e]?C[e]:(g("[vue-mfe/getRouteEntry]: resources object: ",n),y(`[vue-mfe/getRouteEntry]: The '${e}' cannot be found in resources object: ${JSON.stringify(Object.keys(n))}`),void t(!1)):t({name:404}))}(u,t).then(e=>d&&o(e)&&!n(e)?e:function(e,t){if(n(e)&&e.length)return f(e.map(e=>()=>h(e,t))).catch(e=>{throw e});if(a(e))return f([()=>h(e,t)])}(e,b(u))).then(e=>{if(e)return G(e);throw new Error(`[vue-mfe/lazyloader]: Cannot get valid value of Module ${u}`)}).then(n=>{if(!n)throw new Error("[vue-mfe/lazyloader]: Register dynamic routes failed");t(e),r(p)&&p(u,c)}).catch(e=>{r(m)?m(e,t):t(!1)})}function G(e){e=u(e);const t=N(),a=t.app||{};let i=null;if(e){if(r(e))return Promise.resolve(e(a)).then(e=>n(e)&&e.length?t.addRoutes(e):!1===e?y(`[vue-mfe/installModule]: Module ${name} initialize failed.`):void 0);if(n(e))i=e;else if(o(e)){if(r(e.init)&&e.init(a),!e.routes||!e.routes.length)return y(`[vue-mfe/installModule]: Must pass a valid routes array in 'module.routes' property of ${name}!`);i=e.routes}return t.addRoutes(i),!0}return!1}function k(e,t,n){let r=z(),o=r?j(e):P(e,n);return r||(o._config=t||{},l(window,"GlobalPageRouter",o),function(e){e.beforeEach((t,n,r)=>{d||p?0===e.match(t.path).matched.length?L(t,r):r():r({name:404})})}(o)),o}function z(){return null!==window.GlobalPageRouter&&null!==N()}function B(){return z()&&N()._config||{}}export{k as createPageRouter,N as getMasterRouter,T as getMasterRoutes,b as createMasterRouter,z as hasMasterRouter,B as getMasterConfig};