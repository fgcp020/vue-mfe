/*!
  * vue-mfe v1.0.4
  * (c) 2019 Vuchan
  * @license MIT
  */
import t from"vue-router";const e=!1,n=()=>{},r=t=>Array.isArray(t),i=t=>t&&"function"==typeof t,s=t=>t&&"object"==typeof t,o=t=>"string"==typeof t,a=t=>Array.prototype.slice.call(t),h="undefined"!=typeof console&&"function"==typeof console.warn;function l(t,e,n){return t?i(e)&&e():i(n)&&n()}const c=t=>r=>l(e,()=>h&&console.log.apply(null,t?[t,...a(r)]:r),n),p=t=>r=>{const i=e?t=>{throw new Error(t)}:h?console.warn:n;return l(!0,()=>{i.apply(null,t?[[t,...a(r)].join(" > ")]:r)})},u=t=>t&&t.default||t,f=t=>t.reduce((t,e)=>t.then(t=>e(t)).catch(t=>{throw t}),Promise.resolve());function d(){this.events={}}function m(t){t&&t instanceof HTMLElement&&("function"==typeof t.remove?t.remove():t.parentNode.removeChild(t))}d.prototype.on=function(t,e){return this.events[t]?this.events[t].push(e):this.events[t]=[e],this.events[t]},d.prototype.off=function(t,e){if(t){let n=this.events[t];if(n&&n.length)return e?n=n.filter(t=>t===e):(delete this.events[t],!0)}else this.events={}},d.prototype.emit=function(t,...e){const n=this.events[t];if(n)return n.forEach(t=>t.apply(null,e)),!0};class g{static log(){return c("VueMfe."+g.name)(arguments)}static warn(){return p("VueMfe."+g.name)(arguments)}constructor(){this.cached={}}load({name:t}){return this.getRouteEntry(t).then(n=>{const o=i(n)?n():n;return g.log(`start to load ${t} resources:`,o),e&&s(o)&&!r(o)?o:this.installResources((r(o)?o:[o]).filter(Boolean),this.getName(t))})}getRouteEntry(t){let e=this.cached[t];return e?Promise.resolve(e):Promise.resolve(this.getResource(t)).then((e={})=>{if(this.cached=Object.assign({},this.cached,e),e[t])return e[t];g.log("all resources",JSON.stringify(e)),g.warn(`The App '${t}' cannot be found in method 'config.getResource()'`)})}installResources(t,e){const n=t.filter(t=>t.endsWith(".css")),i=t.filter(t=>t.endsWith(".js"));if(r(n)&&n.length&&Promise.all(n.map(t=>(function(t){const e=document.createElement("link");return e.type="text/css",e.rel="stylesheet",e.charset="utf-8",e.href=t,e.setAttribute("force",!1),new Promise((t,n)=>{let r=setTimeout(()=>i(!0),12e3);function i(t){clearTimeout(r),e.onerror=e.onload=e.onreadystatechange=null,t&&e&&m(e)}e.onload=function(){i(),t(...arguments)},e.onerror=function(){i(!0),n(...arguments)},document.head.appendChild(e)})})(t))).catch(t=>g.warn(t)),r(i)&&i.length)return f(i.map(t=>()=>(function(t,e){const n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=t,n.async=!0,n.setAttribute("nonce","nonce"),new Promise((r,i)=>{let s=setTimeout(()=>h(`Reject script ${t}: LOAD_SCRIPT_TIMEOUT`),12e3);function o(){clearTimeout(s),n.onerror=n.onload=n.onreadystatechange=null,m(n)}function a(){o(),r(e?window[e]:void 0,...arguments)}function h(){o(),i(...arguments)}void 0!==n.readyState?n.onreadystatechange=function(t){"loaded"!==n.readyState&&"complete"!==n.readyState||e&&!window[e]?h("Unknown error happened",t):a()}:(n.onload=a,n.onerror=function(e){h(`GET ${t} net::ERR_CONNECTION_REFUSED`,e)}),document.body.appendChild(n)})})(t,e))).catch(t=>{throw t});g.warn(`no any valid entry script be found in ${t}`)}getResource(t){return this.getConfig(t).getResource()}getName(t){return this.getConfig(t).getNamespace(t)}getConfig(t="*"){return this.configs[t]||this.configs["*"]}setConfig(t,e){return s(t)&&(e=t,t="*"),this.configs||(this.configs={}),this.configs[t]=e,this}}function A(t=[],e){let n=0,r=null;const i=t.length;for(;n<i;){const i=t[n],{path:s,children:o}=i;if(s===e)return i;if(o&&o.length?(r=A(o,e),n++):n++,r)return r}}function E(t,e){return"/"===e&&"/"!==t&&t.startsWith("/")?y(t):y(e)+y(t)}function y(t){return(t="/"!==t?t.replace(/\/?$/,""):t)?function(t){return"/"===t.charAt(0)}(t)?t:"/"+t:"/"}var _=function(t,e){var n,r=[],i=0,s=0,o="",a=e&&e.delimiter||w,h=e&&e.whitelist||void 0,l=!1;for(;null!==(n=P.exec(t));){var c=n[0],p=n[1],u=n.index;if(o+=t.slice(s,u),s=u+c.length,p)o+=p[1],l=!0;else{var f="",d=n[2],m=n[3],g=n[4],A=n[5];if(!l&&o.length){var E=o.length-1,y=o[E],_=!h||h.indexOf(y)>-1;_&&(f=y,o=o.slice(0,E))}o&&(r.push(o),o="",l=!1);var R="+"===A||"*"===A,T="?"===A||"*"===A,C=m||g,x=f||a;r.push({name:d||i++,prefix:f,delimiter:x,optional:T,repeat:R,pattern:C?O(C):"[^"+v(x===a?x:x+a)+"]+?"})}}(o||s<t.length)&&r.push(o+t.substr(s));return r},R=function(t,e,n){for(var r=(n=n||{}).strict,i=!1!==n.start,s=!1!==n.end,o=n.delimiter||w,a=[].concat(n.endsWith||[]).map(v).concat("$").join("|"),h=i?"^":"",l=0;l<t.length;l++){var c=t[l];if("string"==typeof c)h+=v(c);else{var p=c.repeat?"(?:"+c.pattern+")(?:"+v(c.delimiter)+"(?:"+c.pattern+"))*":c.pattern;e&&e.push(c),c.optional?c.prefix?h+="(?:"+v(c.prefix)+"("+p+"))?":h+="("+p+")?":h+=v(c.prefix)+"("+p+")"}}if(s)r||(h+="(?:"+v(o)+")?"),h+="$"===a?"$":"(?="+a+")";else{var u=t[t.length-1],f="string"==typeof u?u[u.length-1]===o:void 0===u;r||(h+="(?:"+v(o)+"(?="+a+"))?"),f||(h+="(?="+v(o)+"|"+a+")")}return new RegExp(h,function(t){return t&&t.sensitive?"":"i"}(n))},w="/",P=new RegExp(["(\\\\.)","(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?"].join("|"),"g");function v(t){return t.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function O(t){return t.replace(/([=!:$\/()])/g,"\\$1")}class T{static warn(){return p(T.name)(arguments)}constructor(t){t.addRoutes!==this.addRoutes&&(t.addRoutes=this.addRoutes.bind(this)),this.router=t,this.routes=t.options.routes,this.pathMap={},this.pathList=[],this.appsMap={},this._init()}_init(){this.refreshAndCheckState(this.routes)}addRoutes(n,r,i){e&&(console.log(this.pathList),console.log(this.pathMap)),this.refreshAndCheckState(n,r),this.router.matcher=new t(this.normalizeOptions(this.adaptRouterOptions(i||this.router),{routes:n},r)).matcher}adaptRouterOptions(e){if(e){if(e instanceof t)return e.options;if(r(e))return{routes:e}}return{}}normalizeOptions(t,e,n){const{routes:r=[],...i}=t,{routes:s=[],...o}=e;return Object.assign({routes:this.mergeRoutes(r,s,n)},o,i)}mergeRoutes(t,e,n){const r=n;return e.forEach(e=>{if(o(e.parentPath)?(n=e.parentPath,delete e.parentPath):n=r,o(n))if(""===n)t.push(e);else{const r=A(t,n);let i=e.path;r&&(r.children||(r.children=[])).push(Object.assign({},e,{path:n&&i.startsWith("/")?i=i.replace(/^\/*/,""):i}))}else t.push(e)}),t}refreshAndCheckState(t,e){t.forEach(({path:t,parentPath:n,name:r,children:i,childrenApps:s})=>{if(n?t=this.genParentPath(t,n,r):e&&(t=this.genParentPath(t,e,r)),t&&(this.pathExists(t)?T.warn(`The path ${t} in pathList has been existed`):this.pathList.push(t)),r&&(this.nameExists(r)?T.warn(`The name ${r} in pathMap has been existed`):this.pathMap[r]=t),s&&[].concat(s).forEach(e=>{if("object"==typeof e){const[n,r]=Object.entries(e).shift();this.appsMap[E(r,t)]=n}else this.appsMap[E(e,t)]=r}),i&&i.length)return this.refreshAndCheckState(i,t)})}genParentPath(t,e,n){return this.pathExists(e)?E(t,e):(T.warn(`Cannot found the parent path ${e} ${n?"of "+n:""} in Vue-MFE MasterRouter`),"")}pathExists(t){return this.pathList.includes(t)}nameExists(t){return this.pathMap[t]}getChildrenApps(t){let e=this.appsMap[t];if(!e){const n=function(t,e){const n=Object.keys(t);if(n){const t=n.map(t=>R(_(t)));let r=0,i=t.length;for(;r++<i;)if(t[r].test(e))return n[r]}}(this.appsMap,t);n&&(e=this.appsMap[n])}return e?[].concat(e):null}findRoute(t,e){let n=o(e)&&e||s(e)&&e.path;return n&&A(t||this.routes,n)||null}}let C;class x extends d{static log(){return c(x.name)(arguments)}static warn(){return p(x.name)(arguments)}static install(t){if(x.install.installed&&C===t)return;if(x.install.installed=!0,C=t,Number(t.version.split(".")[0])>=2)t.mixin({beforeCreate:e});else{const n=t.prototype._init;t.prototype._init=function(t={}){t.init=t.init?[e].concat(t.init):e,n.call(this,t)}}function e(){const t=this.$options;t.mfe?this.$mfe="function"==typeof t.mfe?t.mfe():t.mfe:t.parent&&t.parent.$mfe&&(this.$mfe=t.parent.$mfe)}}constructor(e={}){super(),Vue||"undefined"==typeof window||!window.Vue||x.install.installed||x.install(window.Vue),e&&e.router&&e.router instanceof t||x.warn('Must pass the router property in "Vue.use(VueMfe, { router, config })"');const{router:n,...r}=e;this.router=n,this.config=Object.assign({},x.DEFAULTS,r),this.installedApps={},this.helpers=new T(this.router),this.lazyloader=(new g).setConfig(this.config),this._init()}_init(){this.router.beforeEach((t,e,n)=>{if(0!==t.matched.length&&0!==this.router.match(t.path).matched.length)return n();{const r=this._getPrefixName(t),i={name:r,to:t,from:e,next:n};if(!this.isInstalled(r))return this.installApp(i);{const e=this.helpers.getChildrenApps(t.path||t.fullPath);if(e&&e.length)return this._installChildrenApps(e,i);{const e=new Error(`${r} has been installed but it has no any path ${t.path}`);e.code=x.ERROR_CODE.LOAD_DUPLICATE_WITHOUT_PATH,this.emit("error",e,i)}}}})}installApp(t){const{name:e,next:n,to:r}=t;if(this.isInstalled(e))return!0;this.installedApps[e]=x.LOAD_STATUS.START,this.emit("start",t);return this.loadAppEntry(t).then(t=>this.executeAppEntry(t)).then(t=>this.installAppModule(t)).then(i=>(x.log(`install app ${e} success`,i),i&&(this.installedApps[e]=x.LOAD_STATUS.SUCCESS,n&&r&&n(r),this.emit("end",t)),i)).catch(r=>{r instanceof Error||(r=new Error(r)),r.code||(r.code=x.ERROR_CODE.LOAD_ERROR_HAPPENED),this.installedApps[e]=x.LOAD_STATUS.FAILED,n&&n(!1),this.emit("error",r,t)})}loadAppEntry(t){return this.lazyloader.load("string"==typeof t?{name:t}:t)}executeAppEntry(t){t=u(t);const e=this.router&&this.router.app;return i(t)?Promise.resolve(t(e)):r(t)?t:s(t)?i(t.init)&&Promise.resolve(t.init(e)):void 0}installAppModule(t){if(r(t))return t.length?(this.helpers.addRoutes(t,this.config.parentPath),!0):(x.warn("`Route[]` has no any valid item"),!1);{let e=new Error(`Module ${name} initialize failed.`);return t instanceof Error&&(e=t),e.code=x.ERROR_CODE.LOAD_APP_INIT_FAILED,x.warn(e),!1}}isInstalled(t){let e=t;return s(t)&&/\//.exec(t.path)?e=this._getPrefixName(t):o(t)&&/\//.exec(t)&&(e=this._getPrefixNameByDelimiter(t,"/")),this.installedApps[e]===x.LOAD_STATUS.SUCCESS}preinstall(t){return t&&this.installApp({name:t})}_installChildrenApps(t,{next:e,to:n}){const r=t.map(t=>this.installApp({name:t}));return Promise.all(r).then(t=>t.every(Boolean)).then(t=>t&&e&&n&&e(n))}_getPrefixName(t){return t.domainName||(t.name&&t.name.includes(".")?this._getPrefixNameByDelimiter(t.name,"."):this._getPrefixNameByDelimiter(t.path,"/"))}_getPrefixNameByDelimiter(t,e){return(this.config.ignoreCase?t.toLowerCase():t).split(e).filter(t=>!Object.values(this.router.currentRoute.params).includes(t)).filter(Boolean).map(t=>t.trim()).shift()}}x.version="1.0.4",x.DEFAULTS={ignoreCase:!0,parentPath:null,getNamespace:t=>`__domain__app__${t}`},x.LOAD_STATUS={SUCCESS:1,START:0,FAILED:-1},x.ERROR_CODE={LOAD_ERROR_HAPPENED:x.LOAD_STATUS.FAILED,LOAD_DUPLICATE_WITHOUT_PATH:-2,LOAD_APP_INIT_FAILED:-3};export default x;