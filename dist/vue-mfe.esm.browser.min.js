/*!
  * vue-mfe v1.0.5
  * (c) 2019 Vuchan
  * @license MIT
  */
import e from"vue-router";const t=e=>Array.isArray(e),n=e=>e&&"function"==typeof e,r=e=>e&&"object"==typeof e,o=e=>"string"==typeof e,i=new Map,c=()=>u().router,s=()=>c().app,a=e=>u(e).globalVar||"__domain__app__"+e,u=(e="*")=>i.get(e)||{},f=(e,t)=>(r(e)&&(e=(t=e).prefix||"*"),!(!o(e)||!r(t))&&i.set(e,t)),l=!1,h="undefined"!=typeof console&&"function"==typeof console.warn,p=function(){if(l)throw Error.apply(window,arguments);h&&console.warn.apply(arguments)},d=e=>e&&e.default||e,m=(e,t="/")=>e.split(t||".").filter(Boolean).map(e=>e.trim()).shift();function g(e){e&&e instanceof HTMLElement&&("function"==typeof e.remove?e.remove():e.parentNode.removeChild(e))}let y={};function E(e){return y[e]||v(e).then(o=>{const i=n(o)?o():o;try{return l&&r(i)&&!t(i)?i:y[e]=w((t(i)?i:[i]).filter(Boolean),a(e))}catch(e){throw console.log("error: ",e),new Error(e)}})}const v=e=>Promise.resolve((e=>{let t=u(e);if(t&&t.resources||(t=u()),t&&t.resources){if(n(t.resources))return t.resources();if(r(t.resources))return t.resources}})(e)).then((t={})=>t[e]||p(`The App key '${e}' cannot be found in ${JSON.stringify(t)}`)),w=(e,n)=>{const r=e.filter(e=>e.endsWith(".css")),o=e.filter(e=>e.endsWith(".js"));if(t(r)&&r.length&&Promise.all(r.map(e=>(function(e){const t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.charset="utf-8",t.href=e,t.setAttribute("force",!1),new Promise((e,n)=>{let r=setTimeout(()=>o(!0),12e3);function o(e){clearTimeout(r),t.onerror=t.onload=t.onreadystatechange=null,e&&t&&g(t)}t.onload=function(){o(),e(...arguments)},t.onerror=function(){o(!0),n(...arguments)},document.head.appendChild(t)})})(e))).catch(p),t(o)&&o.length)return A(o.map(e=>()=>(function(e,t){const n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=e,n.async=!0,n.setAttribute("nonce","nonce"),new Promise((r,o)=>{let i=setTimeout(()=>a(`Reject script ${e}: LOAD_SCRIPT_TIMEOUT`),12e3);function c(){clearTimeout(i),n.onerror=n.onload=n.onreadystatechange=null,g(n)}function s(){c(),r(t?window[t]:void 0,...arguments)}function a(){c(),o(...arguments)}void 0!==n.readyState?n.onreadystatechange=function(e){"loaded"!==n.readyState&&"complete"!==n.readyState||t&&!window[t]?a("Unknown error happened",e):s()}:(n.onload=s,n.onerror=function(t){a(`GET ${e} net::ERR_CONNECTION_REFUSED`,t)}),document.body.appendChild(n)})})(e,n))).catch(e=>{p(e)});p(`No any valid script be found in ${e}`)},A=e=>e.reduce((e,t)=>e.then(e=>t(e)).catch(e=>{throw e}),Promise.resolve()),O=e=>{if(!u())throw new Error("Before you calls `VueMfe.Lazy(url: string)` must setting its config use like `VueMfe.lazy.setConfig({ resource: Resources })`");const t=(e=>u(e).name)(e),r=e.slice(t.length+1);return t&&E(t).then(e=>{const t=((e,t)=>t.split(".").reduce((e,t)=>e[t],e))(e,r);return n(t)?t():t})};O.setConfig=function(e){f(e)};const T=1;var R=Object.freeze({SUCCESS:T,START:0,FAILED:-1});const b={};function P(e){return b[e]===T}function _(e,t){return b[e]=t}function $(e,t){return"/"===t&&"/"!==e&&e.startsWith("/")?x(e):x(t)+x(e)}function x(e){return(e="/"!==e?e.replace(/\/?$/,""):e)?function(e){return"/"===e.charAt(0)}(e)?e:"/"+e:"/"}var S=function(e,t){var n,r=[],o=0,i=0,c="",s=t&&t.delimiter||C,a=t&&t.whitelist||void 0,u=!1;for(;null!==(n=D.exec(e));){var f=n[0],l=n[1],h=n.index;if(c+=e.slice(i,h),i=h+f.length,l)c+=l[1],u=!0;else{var p="",d=n[2],m=n[3],g=n[4],y=n[5];if(!u&&c.length){var E=c.length-1,v=c[E],w=!a||a.indexOf(v)>-1;w&&(p=v,c=c.slice(0,E))}c&&(r.push(c),c="",u=!1);var A="+"===y||"*"===y,O="?"===y||"*"===y,T=m||g,R=p||s;r.push({name:d||o++,prefix:p,delimiter:R,optional:O,repeat:A,pattern:T?I(T):"[^"+L(R===s?R:R+s)+"]+?"})}}(c||i<e.length)&&r.push(c+e.substr(i));return r},j=function(e,t,n){for(var r=(n=n||{}).strict,o=!1!==n.start,i=!1!==n.end,c=n.delimiter||C,s=[].concat(n.endsWith||[]).map(L).concat("$").join("|"),a=o?"^":"",u=0;u<e.length;u++){var f=e[u];if("string"==typeof f)a+=L(f);else{var l=f.repeat?"(?:"+f.pattern+")(?:"+L(f.delimiter)+"(?:"+f.pattern+"))*":f.pattern;t&&t.push(f),f.optional?f.prefix?a+="(?:"+L(f.prefix)+"("+l+"))?":a+="("+l+")?":a+=L(f.prefix)+"("+l+")"}}if(i)r||(a+="(?:"+L(c)+")?"),a+="$"===s?"$":"(?="+s+")";else{var h=e[e.length-1],p="string"==typeof h?h[h.length-1]===c:void 0===h;r||(a+="(?:"+L(c)+"(?="+s+"))?"),p||(a+="(?="+L(c)+"|"+s+")")}return new RegExp(a,function(e){return e&&e.sensitive?"":"i"}(n))},C="/",D=new RegExp(["(\\\\.)","(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?"].join("|"),"g");function L(e){return e.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function I(e){return e.replace(/([=!:$\/()])/g,"\\$1")}function N(e){return e&&r(e)&&e.path&&e.component}const M=-2;var U=Object.freeze({LOAD_ERROR_HAPPENED:-1,LOAD_DUPLICATE_WITHOUT_PATH:M,LOAD_APP_INIT_FAILED:-3});const k="load-error";var z=Object.freeze({LOAD_START:"load-start",LOAD_SUCCESS:"load-success",LOAD_ERROR:k});const W=e=>{const{name:o,next:i,to:a}=e;if(P(o))return!0;const f=s();_(o,0),f.$emit("load-start",e);return E(o).then(e=>(function(e){if(r(e)&&N(e))return c().addRoutes([e]);if(t(e)&&e.every(N))return c().addRoutes(e);const{init:o,routes:i,parentPath:a}=d(e),{parentPath:f}=u();return Promise.resolve(n(o)&&o(s())).then(()=>{c().addRoutes(i,a||f)})})(e)).then(()=>{_(o,T),f.$emit("load-success",e),i&&a&&i(a)}).catch(t=>{t instanceof Error||(t=new Error(t)),t.code||(t.code=-1),_(o,-1),f.$emit(k,t,e),i&&i(!1)})};const B={},H=(e,t)=>{e&&[].concat(e).forEach(e=>{if("object"==typeof e){Object.keys(e).forEach(n=>{const r=e[n];B[$(r,t)]=n})}else B[$(e,t)]=name})},V=e=>{let t=B[e];if(!t){const n=function(e,t){const n=Object.keys(e);if(n){const e=n.map(e=>j(S(e)));let r=0,o=e.length;for(;r++<o;)if(e[r].test(t))return n[r]}}(B,e);n&&(t=B[n])}return t?[].concat(t):null},F=e=>{const t=e.map(e=>W({name:e}));return Promise.all(t).then(e=>e.every(Boolean))},G=[],J={},Y=e=>G.includes(e),q=e=>J[e],K=(e,t,n)=>Y(t)?$(e,t):(p(`Cannot found the parent path ${t} ${n?"of "+n:""} in router`),"");function Q(e,t){e.forEach(({path:e,parentPath:n,name:r,children:o,childrenApps:i})=>{if(n?e=K(e,n,r):t&&(e=K(e,t,r)),e&&(Y(e)?p(`The path ${e} in pathList has been existed`):G.push(e)),r&&(q(r)?p(`The name ${r} in pathMap has been existed`):J[r]=e),H(i,e),o&&o.length)return Q(o,e)}),l&&(console.log(G),console.log(J))}function X(n,r,o){Q(n,r),c().matcher=new e(function(e,t,n){const{routes:r=[],...o}=e,{routes:i=[],...c}=t;return Object.assign({routes:Z(r,i,n)},c,o)}(function(n){if(n){if(n instanceof e)return n.options;if(t(n))return{routes:n}}return{}}(o||c()),{routes:n},r)).matcher}function Z(e,t,n){const r=n;return t.forEach(t=>{if(o(t.parentPath)?(n=t.parentPath,delete t.parentPath):n=r,o(n))if(""===n)e.push(t);else{const r=function e(t=[],n){if(t){let r;for(let o=0;o<t.length;o++){if((r=t[o]).path===n)return r;if(r.children&&(r=e(r.children,n)))return r}}}(e,n);let o=t.path;r&&(r.children||(r.children=[])).push(Object.assign({},t,{path:n&&o.startsWith("/")?o=o.replace(/^\/*/,""):o}))}else e.push(t)}),e}function ee(e){e.beforeEach(function(t,n,i){if(0!==t.matched.length&&0!==e.match(t.path).matched.length)return i();{const e=(c=t.fullPath||t.path,o(c)?m(c):r(c)?c.prefix:void 0),a={name:e,to:t,from:n,next:i};if(!P(e))return W(a);{const n=V(t.fullPath||t.path);if(n&&n.length)return function(e,{next:t,to:n}){return F(e).then(e=>e&&t&&n&&t(n)).catch(e=>{console.log("error: ",e)})}(n,a);!function(e,t){const n=new Error(`${e} has been installed but it has no any path like ${t.path}`);n.code=M,s().$emit(k,n)}(e,t)}}var c})}const te={sensitive:!1,parentPath:"/",resources:()=>{}};function ne(e){var t;f(Object.assign({},te,e)),(t=e.router).addRoutes!==X&&(t.addRoutes=X.bind(t)),Q(t.options.routes),ee(t)}function re(e){if(!e.prefix)throw new Error("Missing property `prefix: string` in config");if(!e.routes)throw new Error("Missing property `routes: Route[]` in config");return f(e),e}export default{version:"1.0.5",lazy:O,createApp:ne,createSubApp:re,isInstalled:P,EVENT_TYPE:z,ERROR_CODE:U,LOAD_STATUS:R};export{ne as createApp,re as createSubApp};