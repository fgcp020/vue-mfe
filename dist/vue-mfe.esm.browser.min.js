/*!
  * vue-mfe v1.1.2
  * (c) 2020 GivingWu
  * @license MIT
  */
import e from"vue-router";const t=!1,n=e=>Array.isArray(e),r=e=>e&&"function"==typeof e,o=e=>e&&"object"==typeof e,i=e=>"string"==typeof e,s=e=>o(e)&&e instanceof Promise&&r(e.then),c="undefined"!=typeof console&&"function"==typeof console.warn,u=function(){if(t)throw Error.apply(window,arguments);c&&console.warn.apply(window,arguments)};function a(e){e&&e instanceof HTMLElement&&("function"==typeof e.remove?e.remove():e.parentNode.removeChild(e))}function f(e){return`${o(e)?JSON.stringify(e):""+e}`}const l=new Map,p=()=>w().router,h=()=>p().app,d=e=>w(e).globalVar||"__domain__app__"+e,m=e=>w(e).name,w=(e="*")=>l.get(e)||{},g=(e,t)=>(o(e)&&(e=(t=e).prefix||"*"),!(!i(e)||!o(t))&&l.set(e,t)),y="load-error";function E(e,t,n,r,o){e||e instanceof Error||(e=new Error(`\u3010${m(r)||r}\u3011\uff1a`+t)),n&&!e.code&&(e.code=n),r&&!e.name&&(e.name=r),h().$emit(y,e,o)}const v="LOAD_ERROR_HAPPENED",$="LOAD_DUPLICATE_WITHOUT_PATH",R=new Map;let P={};function b(e){return P[e]?Promise.resolve(P[e]):x(e).then(i=>{const c=r(i)?i():i;try{if(t&&o(c)&&!n(c))return c;{const t=O((n(c)?c:[c]).filter(Boolean),d(e));if(s(t))return t.then(t=>t&&(P[e]=t))}}catch(e){throw new Error(e)}})}const x=e=>Promise.resolve((e=>{const t=R.get(e);if(t&&o(t))return t;try{let t=w(e);if(t&&t.resources||(t=w()),t&&t.resources){if(r(t.resources)){const n=t.resources();return R.set(e,n),n}if(o(t.resources)){const n=t.resources;return R.set(e,n),n}}}catch(t){E(t,"Cannot get the resources .","LOAD_RESOURCES_ERROR",e)}})(e)).then(t=>t&&t[e]||u(`The App key '${e}' cannot be found in ${JSON.stringify(t)}`)),O=(e,t)=>{const r=e.filter(e=>e.endsWith(".css")),o=e.filter(e=>e.endsWith(".js"));return n(r)&&r.length&&Promise.all(r.map(e=>(function(e){const t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.charset="utf-8",t.href=e,t.setAttribute("force",!1),new Promise((e,n)=>{let r=setTimeout(()=>o(!0),12e3);function o(e){clearTimeout(r),t.onerror=t.onload=t.onreadystatechange=null,e&&t&&a(t)}t.onload=function(){o(),e(...arguments)},t.onerror=function(){o(!0),n(new Error(...arguments))},document.head.appendChild(t)})})(e))).catch(u),n(o)&&o.length?T(o.map(e=>()=>(function e(t,n=3,r=0){return new Promise((o,i)=>t().then(o).catch(s=>{1!==n?setTimeout(()=>{e(t,n-1,r).then(o,i)},r):i(s)}))})(()=>(function(e,t){const n=document.createElement("script");return n.type="text/javascript",n.charset="utf-8",n.src=e,n.async=!0,n.setAttribute("nonce","nonce"),new Promise((r,o)=>{let i=setTimeout(()=>u(`Reject script ${e}: LOAD_SCRIPT_TIMEOUT`),12e3);function s(){clearTimeout(i),n.onerror=n.onload=n.onreadystatechange=null,a(n)}function c(){s(),r(t?window[t]:void 0,...arguments)}function u(){s(),o(new Error(...arguments))}void 0!==n.readyState?n.onreadystatechange=function(e){"loaded"!==n.readyState&&"complete"!==n.readyState||t&&!window[t]?u(`Unknown error happened: ${f(e)}`):c()}:(n.onload=c,n.onerror=function(t){u(`GET ${e} net::ERR_CONNECTION_REFUSED:  ${f(t)}`)}),document.body.appendChild(n)})})(e,t)))):u(`No any valid script be found in ${e}`)},T=e=>e.reduce((e,t)=>e.then(e=>t(e)).catch(e=>{throw e}),Promise.resolve()),M=(e="",t="/")=>e.split(t).map(e=>e.trim()).filter(Boolean).shift();function A(e){return!!(o(e)&&(e.fullPath||e.path||e.name)&&e.component)}const _=1,S=0,j={};function C(e){return j[e]===_}function V(e,t){return j[e]=t}const N=e=>{const{name:t,next:i,to:s}=e;if(C(t))return!0;const c=h();V(t,S),c.$emit("load-start",e);return b(t).then(e=>(function(e,t){if(o(e)&&A(e))return p().addRoutes([e]);if(n(e)&&e.every(A))return p().addRoutes(e);const i=L(e),{parentPath:s}=w();if(o(i)){const{init:e,routes:t,parentPath:n}=i;return Promise.resolve(r(e)&&e(h())).then(()=>{p().addRoutes(t,n||s)})}throw new Error(`\n      Cannot not found 'export default VueMfe.createSubApp({ prefix: ${t}, routes: [] })' in '${t}/src/portal.entry.js'\n    `)})(e,t)).then(()=>(V(t,_),c.$emit("load-success",e),i&&s&&i(s),!0)).catch(n=>{V(t,-1),E(n,"",v,t,e),i&&i(!1)})};const L=e=>e&&e.default||e;function D(e,t="."){if(!w())throw new Error("Before you call `VueMfe.Lazy(url: string)` must set its config by `VueMfe.Lazy.setConfig({ resource: Resource[] })`");const n=M(e,t),o=e.slice(n.length+t.length);return n&&b(n).then(e=>{const t=k(L(e),o);return r(t)?t():t})}D.setConfig=function(e){return g(e)};const k=(e,t)=>t.split(".").reduce((e,t)=>e[t],e);var I=function(e,t){var n,r=[],o=0,i=0,s="",c=t&&t.delimiter||J,u=t&&t.whitelist||void 0,a=!1;for(;null!==(n=W.exec(e));){var f=n[0],l=n[1],p=n.index;if(s+=e.slice(i,p),i=p+f.length,l)s+=l[1],a=!0;else{var h="",d=n[2],m=n[3],w=n[4],g=n[5];if(!a&&s.length){var y=s.length-1,E=s[y],v=!u||u.indexOf(E)>-1;v&&(h=E,s=s.slice(0,y))}s&&(r.push(s),s="",a=!1);var $="+"===g||"*"===g,R="?"===g||"*"===g,P=m||w,b=h||c;r.push({name:d||o++,prefix:h,delimiter:b,optional:R,repeat:$,pattern:P?H(P):"[^"+B(b===c?b:b+c)+"]+?"})}}(s||i<e.length)&&r.push(s+e.substr(i));return r},U=function(e,t,n){for(var r=(n=n||{}).strict,o=!1!==n.start,i=!1!==n.end,s=n.delimiter||J,c=[].concat(n.endsWith||[]).map(B).concat("$").join("|"),u=o?"^":"",a=0;a<e.length;a++){var f=e[a];if("string"==typeof f)u+=B(f);else{var l=f.repeat?"(?:"+f.pattern+")(?:"+B(f.delimiter)+"(?:"+f.pattern+"))*":f.pattern;t&&t.push(f),f.optional?f.prefix?u+="(?:"+B(f.prefix)+"("+l+"))?":u+="("+l+")?":u+=B(f.prefix)+"("+l+")"}}if(i)r||(u+="(?:"+B(s)+")?"),u+="$"===c?"$":"(?="+c+")";else{var p=e[e.length-1],h="string"==typeof p?p[p.length-1]===s:void 0===p;r||(u+="(?:"+B(s)+"(?="+c+"))?"),h||(u+="(?="+B(s)+"|"+c+")")}return new RegExp(u,function(e){return e&&e.sensitive?"":"i"}(n))},J="/",W=new RegExp(["(\\\\.)","(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?"].join("|"),"g");function B(e){return e.replace(/([.+*?=^!:${}()[\]|/\\])/g,"\\$1")}function H(e){return e.replace(/([=!:$/()])/g,"\\$1")}function z(e,t){return"/"===t?"/"!==e?F(e):t:F(t)+F(e)}function F(e){return(e="/"!==e?e.replace(/\/?$/,""):e)?function(e){return"/"===e.charAt(0)}(e)?e:"/"+e:"/"}const G={},q=(e,t)=>{e&&[].concat(e).forEach(e=>{if("object"==typeof e){Object.keys(e).forEach(n=>{const r=e[n];G[z(r,t)]=n})}else G[z(e,t)]=name})};const K=e=>{let t=G[e];if(!t){const n=function(e,t){const n=Object.keys(e);if(n){const e=n.map(e=>U(I(e)));let r=0,o=e.length;for(;r++<o;)if(e[r].test(t))return n[r]}}(G,e);n&&(t=G[n])}return t?[].concat(t):null},Q=e=>{const t=e.map(e=>N({name:e}));return Promise.all(t).then(e=>e.every(Boolean))},X=[],Y={},Z=e=>X.includes(e),ee=e=>Y[e],te=(e,t,n)=>Z(t)?z(e,t):(u(`Cannot found the parent path ${t} ${n?"of "+n:""} in router`),"");function ne(e,n){e.forEach(({path:e,parentPath:t,name:r,children:o,childrenApps:i})=>{if(e&&(t?e=te(e,t,r):n&&(e=te(e,n,r))),e&&(Z(e)?u(`The path ${e} in pathList has been existed`):X.push(e)),r&&(ee(r)?u(`The name ${r} in pathMap has been existed`):Y[r]=e),q(i,e),o&&o.length)return ne(o,e)}),t&&(console.log(X),console.log(Y))}function re(t,r,o){ne(t,r),p().matcher=new e(function(e,t,n){const{routes:r=[],...o}=e,{routes:i=[],...s}=t;return Object.assign({routes:oe(r,i,n)},s,o)}(function(t){if(t){if(t instanceof e)return t.options;if(n(t))return{routes:t}}return{}}(o||p()),{routes:t},r)).matcher}function oe(e,t,n){const r=n;return t.forEach(t=>{if(i(t.parentPath)?(n=t.parentPath,delete t.parentPath):n=r,i(n))if(""===n)e.push(t);else{const r=function e(t=[],n){if(t){let r;for(let o=0;o<t.length;o++){if((r=t[o]).path===n)return r;if(r.children&&(r=e(r.children,n)))return r}}}(e,n);let o=t.path;r&&(r.children||(r.children=[])).push(Object.assign({},t,{path:n&&o.startsWith("/")?o=o.replace(/^\/*/,""):o}))}else e.push(t)}),e}function ie(e){e.beforeEach(function(e,t,n){if((r=e).name&&ee(r.name)||Z(r.path)||0!==r.matched.length)return n();{const r=function(e){if(o(e)){const t=e.fullPath||e.path;if(i(t))return M(t);const n=e.name;if(i(n))return M(n,".")}}(e);if(!r)return;const s={name:r,to:e,from:t,next:n};if(function(e){return j[e]===S}(r))return;if(!C(r))return N(s);{const t=K(e.fullPath||e.path);if(t&&t.length)return function(e,t){const{next:n,to:r,name:o}=t;return Q(e).then(e=>e&&n&&r&&n(r)).catch(e=>{E(e,"",v,o,t)})}(t,s);E(null,`${r} has been installed but it has no any path like ${e.path}`,$,r,s)}}var r})}const se={sensitive:!1,parentPath:"/",resources:()=>{throw new Error("Must implements 'resources: {[prefix: string]: Resources | () => Resources | () => Promise<Resources>}' by yourself.")}};function ce(t){if(!t.router)throw new Error(`Missing property 'router: VueRouter' in config \n${JSON.stringify(t)}`);if(!(t.router instanceof e))throw new Error(`The router must be an instance of VueRouter not ${typeof t.router}`);var n;g(Object.assign({},se,t)),(n=t.router).addRoutes!==re&&(n.addRoutes=re.bind(n)),ne(n.options.routes),ie(n)}function ue(e){if(!e.prefix)throw new Error(`Missing property 'prefix: string' in config \n${JSON.stringify(e)}`);if(!e.routes)throw new Error(`Missing property 'routes: Route[]' in config \n${JSON.stringify(e)}`);return g(e),e}const ae={version:"1.1.2",Lazy:D,createApp:ce,createSubApp:ue,isInstalled:C};"undefined"==typeof window||!window.Vue||window.VueMfe&&window.VueMfe===ae||(window.VueMfe=window.VueMfe&&window.VueMfe.version===ae.version?window.VueMfe:ae);export default ae;export{ce as createApp,ue as createSubApp};